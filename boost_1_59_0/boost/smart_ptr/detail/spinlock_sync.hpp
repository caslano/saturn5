#ifndef BOOST_SMART_PTR_DETAIL_SPINLOCK_SYNC_HPP_INCLUDED
#define BOOST_SMART_PTR_DETAIL_SPINLOCK_SYNC_HPP_INCLUDED

// MS compatible compilers support #pragma once

#if defined(_MSC_VER) && (_MSC_VER >= 1020)
# pragma once
#endif

//
//  Copyright (c) 2008 Peter Dimov
//
//  Distributed under the Boost Software License, Version 1.0.
//  See accompanying file LICENSE_1_0.txt or copy at
//  http://www.boost.org/LICENSE_1_0.txt)
//

#include <boost/smart_ptr/detail/yield_k.hpp>

#if defined( __ia64__ ) && defined( __INTEL_COMPILER )
# include <ia64intrin.h>
#endif

#if defined(BOOST_SP_REPORT_IMPLEMENTATION)

#include <boost/config/pragma_message.hpp>
BOOST_PRAGMA_MESSAGE("Using __sync spinlock")

#endif

namespace boost
{

namespace detail
{

class spinlock
{
public:

    unsigned char v_;

public:

    bool try_lock()
    {
        int r = __sync_lock_test_and_set( &v_, 1 );
        return r == 0;
    }

    void lock()
    {
        for( unsigned k = 0; !try_lock(); ++k )
        {
            boost::detail::yield( k );
        }
    }

    void unlock()
    {
        __sync_lock_release( &v_ );
    }

public:

    class scoped_lock
    {
    private:

        spinlock & sp_;

        scoped_lock( scoped_lock const & );
        scoped_lock & operator=( scoped_lock const & );

    public:

        explicit scoped_lock( spinlock & sp ): sp_( sp )
        {
            sp.lock();
        }

        ~scoped_lock()
        {
            sp_.unlock();
        }
    };
};

} // namespace detail
} // namespace boost

#define BOOST_DETAIL_SPINLOCK_INIT {0}

#endif // #ifndef BOOST_SMART_PTR_DETAIL_SPINLOCK_SYNC_HPP_INCLUDED

/* spinlock_sync.hpp
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
*/