// Copyright (c) 2016 Klemens D. Morgenstern
//
// Distributed under the Boost Software License, Version 1.0. (See accompanying
// file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_PROCESS_POSIX_ON_EXIT_HPP_
#define BOOST_PROCESS_POSIX_ON_EXIT_HPP_

#include <boost/asio/execution.hpp>
#include <boost/process/async.hpp>
#include <boost/process/detail/config.hpp>
#include <boost/process/detail/handler_base.hpp>
#include <boost/process/detail/posix/async_handler.hpp>
#include <system_error>
#include <functional>

namespace boost { namespace process { namespace detail {

template<typename Tuple>
inline asio::io_context& get_io_context(const Tuple & tup);

namespace posix {

struct on_exit_ : boost::process::detail::posix::async_handler
{
    std::function<void(int, const std::error_code&)> handler;
    on_exit_(const std::function<void(int, const std::error_code&)> & handler) : handler(handler)
    {
    }

    template<typename Executor>
    std::function<void(int, const std::error_code&)> on_exit_handler(Executor& exec)
    {
        auto v = boost::asio::prefer(boost::process::detail::get_io_context(exec.seq).get_executor(),
                                     boost::asio::execution::outstanding_work.tracked);
        auto handler_ = this->handler;
        return
            [handler_, v](int exit_code, const std::error_code & ec)
            {
                handler_(exit_code, ec);
            };

    }
};


}}}}
#endif /* BOOST_PROCESS_POSIX_ON_EXIT_HPP_ */

/* on_exit.hpp
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
*/