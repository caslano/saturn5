/* Copyright 2003-2022 Joaquin M Lopez Munoz.
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * See http://www.boost.org/libs/multi_index for library home page.
 */

#ifndef BOOST_MULTI_INDEX_DETAIL_SCOPED_BILOCK_HPP
#define BOOST_MULTI_INDEX_DETAIL_SCOPED_BILOCK_HPP

#if defined(_MSC_VER)
#pragma once
#endif

#include <boost/core/noncopyable.hpp>
#include <boost/type_traits/aligned_storage.hpp>
#include <boost/type_traits/alignment_of.hpp>
#include <functional>
#include <new>

namespace boost{

namespace multi_index{

namespace detail{

/* Locks/unlocks two RAII-lockable mutexes taking care that locking is done in
 * a deadlock-avoiding global order and no double locking happens when the two
 * mutexes are the same.
 */

template<typename Mutex>
class scoped_bilock:private noncopyable
{
public:
  scoped_bilock(Mutex& mutex1,Mutex& mutex2):mutex_eq(&mutex1==&mutex2)
  {
    bool mutex_lt=std::less<Mutex*>()(&mutex1,&mutex2);

    ::new (static_cast<void*>(&lock1)) scoped_lock(mutex_lt?mutex1:mutex2);
    if(!mutex_eq)
      ::new (static_cast<void*>(&lock2)) scoped_lock(mutex_lt?mutex2:mutex1);
  }

  ~scoped_bilock()
  {
    reinterpret_cast<scoped_lock*>(&lock1)->~scoped_lock();
    if(!mutex_eq)
      reinterpret_cast<scoped_lock*>(&lock2)->~scoped_lock();
  }

private:
  typedef typename Mutex::scoped_lock scoped_lock;
  typedef typename aligned_storage<
    sizeof(scoped_lock),
    alignment_of<scoped_lock>::value
  >::type                             scoped_lock_space;

  bool              mutex_eq;
  scoped_lock_space lock1,lock2;
};

} /* namespace multi_index::detail */

} /* namespace multi_index */

} /* namespace boost */

#endif

/* scoped_bilock.hpp
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
*/