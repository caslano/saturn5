
//          Copyright Oliver Kowalke 2013.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_FIBERS_MUTEX_H
#define BOOST_FIBERS_MUTEX_H

#include <boost/config.hpp>

#include <boost/assert.hpp>

#include <boost/fiber/context.hpp>
#include <boost/fiber/detail/config.hpp>
#include <boost/fiber/detail/spinlock.hpp>
#include <boost/fiber/waker.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

#ifdef _MSC_VER
# pragma warning(push)
# pragma warning(disable:4251)
#endif

namespace boost {
namespace fibers {

class condition_variable;

class BOOST_FIBERS_DECL mutex {
private:
    friend class condition_variable;

    detail::spinlock            wait_queue_splk_{};
    wait_queue                  wait_queue_{};
    context                 *   owner_{ nullptr };

public:
    mutex() = default;

    ~mutex() {
        BOOST_ASSERT( nullptr == owner_);
        BOOST_ASSERT( wait_queue_.empty() );
    }

    mutex( mutex const&) = delete;
    mutex & operator=( mutex const&) = delete;

    void lock();

    bool try_lock();

    void unlock();
};

}}

#ifdef _MSC_VER
# pragma warning(pop)
#endif

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBERS_MUTEX_H

/* mutex.hpp
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
*/