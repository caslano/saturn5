
//          Copyright Oliver Kowalke 2013.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)
//
//  based on boost::interprocess::sync::interprocess_spinlock

#ifndef BOOST_FIBERS_RECURSIVE_MUTEX_H
#define BOOST_FIBERS_RECURSIVE_MUTEX_H

#include <cstddef>

#include <boost/config.hpp>

#include <boost/assert.hpp>

#include <boost/fiber/context.hpp>
#include <boost/fiber/detail/config.hpp>
#include <boost/fiber/detail/spinlock.hpp>
#include <boost/fiber/waker.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

#ifdef _MSC_VER
# pragma warning(push)
# pragma warning(disable:4251)
#endif

namespace boost {
namespace fibers {

class condition_variable;

class BOOST_FIBERS_DECL recursive_mutex {
private:
    friend class condition_variable;

    detail::spinlock            wait_queue_splk_{};
    wait_queue                  wait_queue_{};
    context                 *   owner_{ nullptr };
    std::size_t                 count_{ 0 };

public:
    recursive_mutex() = default;

    ~recursive_mutex() {
        BOOST_ASSERT( nullptr == owner_);
        BOOST_ASSERT( 0 == count_);
        BOOST_ASSERT( wait_queue_.empty() );
    }

    recursive_mutex( recursive_mutex const&) = delete;
    recursive_mutex & operator=( recursive_mutex const&) = delete;

    void lock();

    bool try_lock() noexcept;

    void unlock();
};

}}

#ifdef _MSC_VER
# pragma warning(pop)
#endif

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBERS_RECURSIVE_MUTEX_H

/* recursive_mutex.hpp
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
*/