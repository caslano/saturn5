
//          Copyright Nat Goodspeed + Oliver Kowalke 2015.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_FIBERS_ALGO_SHARED_WORK_H
#define BOOST_FIBERS_ALGO_SHARED_WORK_H

#include <condition_variable>
#include <chrono>
#include <deque>
#include <mutex>

#include <boost/config.hpp>

#include <boost/fiber/algo/algorithm.hpp>
#include <boost/fiber/context.hpp>
#include <boost/fiber/detail/config.hpp>
#include <boost/fiber/scheduler.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

#ifdef _MSC_VER
# pragma warning(push)
# pragma warning(disable:4251)
#endif

namespace boost {
namespace fibers {
namespace algo {

class BOOST_FIBERS_DECL shared_work : public algorithm {
private:
    typedef std::deque< context * >  rqueue_type;
    typedef scheduler::ready_queue_type lqueue_type;

    static rqueue_type     	rqueue_;
    static std::mutex   	rqueue_mtx_;

    lqueue_type            	lqueue_{};
    std::mutex              mtx_{};
    std::condition_variable cnd_{};
    bool                    flag_{ false };
    bool                    suspend_{ false };

public:
    shared_work() = default;

    shared_work( bool suspend) :
        suspend_{ suspend } {
    }

	shared_work( shared_work const&) = delete;
	shared_work( shared_work &&) = delete;

	shared_work & operator=( shared_work const&) = delete;
	shared_work & operator=( shared_work &&) = delete;

    void awakened( context * ctx) noexcept override;

    context * pick_next() noexcept override;

    bool has_ready_fibers() const noexcept override {
        std::unique_lock< std::mutex > lock{ rqueue_mtx_ };
        return ! rqueue_.empty() || ! lqueue_.empty();
    }

	void suspend_until( std::chrono::steady_clock::time_point const& time_point) noexcept override;

	void notify() noexcept override;
};

}}}

#ifdef _MSC_VER
# pragma warning(pop)
#endif

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBERS_ALGO_SHARED_WORK_H

/* shared_work.hpp
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
*/