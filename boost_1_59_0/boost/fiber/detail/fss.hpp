
//          Copyright Oliver Kowalke 2013.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)
//
//          based on tss.hpp from boost.thread

#ifndef BOOST_FIBERS_DETAIL_FSS_H
#define BOOST_FIBERS_DETAIL_FSS_H

#include <atomic>
#include <cstddef>

#include <boost/config.hpp>
#include <boost/intrusive_ptr.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

namespace boost {
namespace fibers {
namespace detail {

class fss_cleanup_function {
private:
    std::atomic< std::size_t >  use_count_{ 0 };

public:
    typedef intrusive_ptr< fss_cleanup_function >   ptr_t;

    fss_cleanup_function() = default;

    virtual ~fss_cleanup_function() = default;

    virtual void operator()( void * data) = 0;

    friend inline
    void intrusive_ptr_add_ref( fss_cleanup_function * p) noexcept {
        p->use_count_.fetch_add( 1, std::memory_order_relaxed);
    }

    friend inline
    void intrusive_ptr_release( fss_cleanup_function * p) noexcept {
        if ( 1 == p->use_count_.fetch_sub( 1, std::memory_order_release) ) {
            std::atomic_thread_fence( std::memory_order_acquire);
            delete p;
        }
    }
};

}}}

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif //  BOOST_FIBERS_DETAIL_FSS_H

/* fss.hpp
paZC5sb98Qr5Gffm/bCDfMSKzPm7TIs2aUvu2ZF72qXg0qxuOJxyIhBZNuE0TK7CaxYf6NJphX7j9IGCycAUIidZPL85W/iZcXwEObK0MU/cZaJ4KO+t8CH3DGltZqMX9kQyEVQrdfvpm6NhHBeKT6ufV+uRuszKifKFKF9Q3rGBfdlEbr9AuGwQrt6G/mZcPXV9Ckl09ue4+OaiJPDq1pUNISiyb1ycG3pqzYKeOhD+9wvguhxbd0KkGXEuEtuOljjBHUbfmfFZZjuu4W7PkBzJ9inu6BKcBgVyPhwJSkUFXFAKBFMO9szFyo3sEcioUi+wfLKIPPIBAsjl7Zz+w3Ya9doeyPC3C4oSlxZTa+iKdFnnQ+LsUUBqquk90RdEEvJM8MzsrM27cd2S/FN+N0a7on4l3wUvDPwAE4roAZav/0D5S7zZTf1P0ikjmpWTvkQ7KoGfnNbTnZAi14OMT/LXV4tPAS8uwmoa2SHwLaf0K8pkLvwHsj5u/0kuYzxLiWVS0FJIux74dpIg5T8n7b4l2wUQ5og9hhQEzOkt9oWF9lJoOQBCFxCo40Dg1KCii3PvBsMgio6/TnZIVjZQpzExjqmajJo5ndy3J6G6OlNZqJD6xnSTzirlBJS7UY1gbDt6Z6B+0Q3QOdsRuvEC/zOl88Xr2ZvDIfiYX2GvhJfkm18h0dw3X/tofAfrP5Nw6uvE2ow68BGD3hbiWBm39VYZlG9bQd+y8ter+7pU6GVquHsGsjtcmnalgpeATH54/0xMk5KGV9e/7RQQWQSNPFPANKk6XbLrrGdu53hcFYwh3agOjUnYWNnKehNiq5a9p+5OTif5fXomALfG5jB3L9Kz9UlG21je5ZCM6y1evWQp8FEQdOyxV4eXHcXGm2pKrakzc/7+YraPrI943HKWyT6goUZt/U970jp2Emmj1vMJeweYCs97XLF3P7GV/N9+AoH8NS0t2q0EPX8C8RgdDls33nYhMy5WAMeRG6H4dirVELIEaHBzCWYy2X9XVDzhyBjh1CrUqEBJ+SmEBnvYIglwJUJ87D9IXbIuYhI1Eq04aw0bvxgAmrtZAfbbrc6MgO2gBgSTqdDkCTJlG8ji9Io5zs0FcFVxEcL/ZcpDBF1H+YwtTTclU7Bp6W8LqEgCElNXcCajCBPQqGqPj9sPsGWKj5uZjbBydnHpusjUzzWCSTnEBN4mJAhAs3eDWUgT4UMiEKyZ1mT8bu4wvr5SegIc8tFlWicRFEqEKArgFmkECtm4VL8O70fuPF6nxTbW4edufoF91ciCgJwiRorPPSxJGzGIVloXObmGGL5slMNW7t9/WrEHZaDLcBSM59I4TIf9FFSvlWphDDnZ6Y4adow2TQOAwL9S+nqQ+4edioxRVrnF4X9AP9vtRZcTTfR8bUmR7ciuY7YkDTCe8Czr1b3y4aqTenAY2fxnAgXdrMYxb75sQQX9kGZ+q2AIQA6xNGNh0QIKt3p2WPzltWjna7iThosMVo6fcQ9cT8XBqOO2kWVrIiFhvmQSH3spnen91Ru7/YWYg4oNMuTbjjQY50+3weh/iUdN7jvxWfYf7QxbkrxRDe46uWMDCvAiTNuLMMiUiFL09NARj4aIo3qFjJUl7Og5eBuwibRmh9XTBSl0FLkffY9Zp8u9Gm+XEJ6Dc7VXVqZYeEwKk7uVpnW5xpdIgoCldmJzXnEcBFo60gDQJFOY4W1G/dcX+mrebF2hA8LeesdZ1TYbH8lwcDvH7xYnpxmdIwyxGZQnB2btgCbuMh51Mx1er6hdh9fNNFVn9b4AxyvTuFX73naODTqLAqf9sU//kV+nLx4aG7VHH9tHT7D0NVwBWzjO1VW+D4sYcAlxcopxzVjURXW2PzIZlOCdy1dGgP27J2wolIY5fYQYvzhZKr8zi0klllApLvcMHO8l1/vF+il1J7jaOL9W8HPm9FJAI4mPz1INLBJKoYjXzEaDR3HEayReuZkzk0uJutJnzfYKc4/IiymGmwNXuPKFGqAbvcXGaZlow6G9YhGwRd55gPFybEVELjHuMsrDTcww3lAsk6k4LzkInVra7alJXJDPLBxeXvRvXAYlz6625WlnOoyeR5YEsVU0tWMZ8406hLWxrTahJK0KrYFS2Z0P+llewJGBISl7TJ7KQvj2EXqvX6cn4XmwfVr5WxqWc2W1mqODBakBox52qs1/CIIZm5IRegTFXvhhm9pw25KDJnEMcjGAGp3hzKo/II1kjWGghIRUFVVraQdE8YQXn/xjXSI27Nvv37NwyryX0L/f0xe/v62UM9j7xtUkFEWms/yzdEh6kd0SRXHHoeUp0Mk4xNOlaP9MmXUWFLOGNOr3B2Dxmrs3Kdpxubt+6hOpA2TsqqMjMZEjacDQ+nYRNdwmdSTl4zTarsOEK65DKhswF1pkQv5Ve6TLFzywFCogRoaMc8aBd+iuK3rAFgMRSVCKlDzdkQ1CAFPcuN0OlNLeXOzQf8ZfZ3xXDc1XHuzMBravVZjms1iqEmnjbDEr6sKMQ1dgxeKt5Pd+FoM250PEwJNWa9/swCKXaYsYU0qucNiu9ryL14HWncIJ3RaxwfHb2bfOvGa4pdoLEcou2aemBrcaZw08l9+RKzg4W9dosnSQk4ICZQhdF7ks2fRIp6i5oWfNs/eMqTViQgS3W47ne90wyof+eMEEQdA5N1zp9ACgdpIs8iKNMsKn300xXvk51hahE/6zsi1xrOVeWyWcYAyrsbFglSxVRxedGpStPmcp/7E/FsOZ3i6IoBGTdBhl5TsINQ2ZES4fUCKvI+99FvNt6ckj93/aCaRRI9M8NP9AunH1YpyQPXqryBVeMpSQ9LqtPSt9HkYb4817GDTv3ez2BoFBMHaK1Goqsyz/Kot5MRp7SQdxXWm1NThk9naDz9jxwIrvbBuDEfNPd+MW6oLYtIWhPnHf7qEHp4C4p0lK23zY4hQo5QQmOC82wHDX9TyOFLz3nJkgKY+4Glq6YHrdq6vMAqZ3+3XDx/Vxe+PSbcqJ4aNrgzawk/rtgglnX7MWptszNyJH4U0/sd++0UBQlTD7CfG90iW4I++oL83ux9uVWxfk2TBb2sEhUudI9Km8CAvhpvKyJvHkmqLSiaAtJcduC6xzsa0nq8SAjMTFC0s7iB2yPYl89dvjQbQzQ53NxDme9RlH8piUf91zGWO9Z7iz9+3mFjtw7KN35XN2+rVkM83nzN95vNwO1+czKQGbUPSE30iAeXwW0WJAG5MHILrNr951lL6Q0gnrJ93TjBZfOSZ9VGHVw7Pl/OAHN4bE3LgsxIM0ADnAvFMAGRapTiEHj2ac6vEfVqf198SIZDmBG+IK3lM29amOlX5tFIRjCtKwEa00PwryH3VF9PFv96iJYaGvyCWGp6iFm++09g/wqs/PAjMHol8gYoJDGSLFeqlPQD8yGYxzX6XDaXlk7fualXTb9qOcHlcQic2AjXAoYuOcmS7LCdbcyp6haA81n8g9INlD0Cl4TKG0JQdKtFzOjRk7WdlPunz33yDDlvjkJeyqorr3Bus0WaXV052o72uLXqp55bq0ZS+pHOE2w01raEukTJL7R78f9MXDCpsahUHUJRdEDQ2bm31P5reN05y00qCshNlIW7rYx7MJ8kGyPJd0N4I5KTBKEVorhLiC3+bFW0mHi/PX3aJc4ySOYgSrHl3vnydBl1hF1PJ61oIYndJLDxRsxOjNWqWjB7nJa6DeiDzIC9kNlWbkYGm06rRILsiKilq4prQczYJTqkOa5/44Hba6Qq3pIz7emzJiUoD8EFpkX3cH2TX7Lj3sbn56q6JrjRbqYbSBS25kSRHZ8zHw3RCXtbH94senP7B7m3t3RyBxz2ztTYg9F/wNyErWprshigatSqw5Mx7BE4BEaSGJ1tJ+YZ2gj9P6jjk95J901Fs+Y8FJt9aEV+3kX612+8Vj+pwqgsHQPhpklvU/60YOzkrrLyt8unYRYJcoeda/P+zkeBJ5SmFKlHI1zsSrIAqt8p/6novPw06xvNOmI5j2pCatqZyTTF2yphPSz5YeM+/ajnT2WUHJLNBHVOezkvzUHKsHwqCruxlv90smlh4C9rEHTaJLFLiKxrqb8cWYeCLguzFgjOnCfzXZHlZPIM1Gcovo9MvIMg1ZVY9+uShbPaIZEB/i7A2vethxBbWD7U1aOXgIspTGYnjIMjfhnIE4hvT/sTZDGbYKzMHf4YtPpDOEQ8qKjLOcTnYjla5vi5TfbJKen9olpbct70ndRsAhOcsLjZFHvDcBoo/bZV43KEoAj8tkmkfZWr7Se+LTg8pISdGLOwDFPFURZUpFBkVlNtcXpyOCmo4VqhMPXgk2IFfCSIIwxYkNovQHzJ8uUdQ7H7MSHuc6vdr9vD31u7lrQk1+WkodaRANk7NWAAgs99PR9krlS6chL7bZ3oPMM1AbQnjYhfCwaFRfCTGJak5grb5xAt4lyzbwHJj20XKaoZ3YMxGbFuRoWERhFFs3pBWNbmGJD+luxvoMP52kofiPBFhN+z3iRrswQyzfIJxMGvP014AUtDLZqsqkzGHzPQRJinl5VJTIXwgKjwMecPCtaExJS6d18c1/u4RXIZU1AU8sqjT5dLCk9zY6LsqAiVSTChRLllr8XsHsJLZ1fR7ECW0dz4OWpCwuahl1HCGPL8lsNf9rnqiW2Rt+AeduOv3nYvNNo7oEUcG63WU126DFmLqwUPg9qFX0S5sMKNpdVT8Aiok1Dgwy2d7N+yCK1My+nE2BtHeXbiu/2vcX3r2TGNFjP51EuQfBd05oKuiz7SPrIEyEB5HKvGkRWVE5IwxyfI8VsozIvfuEfkOHcv38KcHYYUa2wdVTEfOQaQAWKKOI/C7wgQi/W+0O2IIM0GZ9/f6J9RLIDg+ExanmWhgEhojEMooenoaQYzzPstdOKIjFxpTbh99kyHLELVX8e5A/w+ZhnH2UcgbiWR6dyWNHiNNd3Ai7PvkIkmoiDjKqUz3MtsUELfUQu9BpkZ8/Hs8mR1f0n0qE10WJ18q4Kj/utzSpBl+esfWgN0uHCjL7s0WUKTtJsPV+D/8qCNhCxWQed1U6dbGb8V3k+Dju7y1j6/dxKWho3FAgdh7QPvwcmv9UYUJZJr0oCLxmW54aclqN1zrrZn+YO0yqnuUCI2zOUn7lPP1zeDWrbT0xmRtJxmJdgoAbKG9B+JfEFUP8wXF9QG1h/HnlFq4grmJv4ZHxzRyQ9TrguYxQVExfr4Ut2Dl1/4eP56MWWDQVV/W1aacW2FozEeEDGL8X/+RPsdhaNzynYRrDRveKvRrLOiUJyG73pQSOX1s7lroPDUgvnVA583l4qADdT8wv04SY6tp/D+EiMSneEJfzIFn0MT25EUq6Rxajbqu8Pz+JKR0FuYDEkKo6BLDBtMytQ1XfWO6bDD5RqB1Ufu5cwcRB6xtLXf/s1shyPJ+34yhgirfmL1mqLVxK6cEJypkmjh+UFLJSnusD6qocCvB8ChIQIMWStGVd5/aYSiASD1nHVeASHbyuLQCvwtyQJbucpPODIiZruJ1PSqMgUcPpgGJJteRQlBozdFKwaCFI6H14p+QytOzmCpU+82HBcpr/0wO5QSTlCrU4g323Tukyqjg5BW3rySlJfeB2VnmR/eiiSZCkEFOgF/GznkY2yzuA5B+II3/KsdOdabWol9XQVYoXogZ8r80Oh3fGR/Gn+cjW8XIFUeBLmlgM2ZjzBY8BpyrCqHZ6zd6DfWsUGGZfwzI5TN8daVQb93JuZIC7u2+4If8pNMjYnO8/rCpmLUXkeW38fIQ0L9wtFJ8UdodQ0+LdRnP/9IE/JuhYSKNQwCLi+EQklQMO5Jtg+N5T8sJv+FWh/BmGhXKXsJg5j0qoYE7xQfwenSINxljxYwjRNqj6D4Co0y0H0a0pkJUbUb22O3eyFdy1i5hwozK9n147IwKCQo2cBrc0+rFt2bN7EgB2rmMCkBMRrk+WKTf/mNS/eLU9+R49k5S/HUs6flgkQm7Q+DXbxSb1GHN2lxKDVtzfvZRG8r8ih5uL8SmBA8fU1XVtM+Dwe3/3oxBbdm+0MinXFPnkBWan5xCZ1QkcvmIQ+3+wy+o/UdeGoWKq9MTz/ywHVExtroC+2M/aH+aYqctptbmFzqGXDZLCQoQvlLVZlv0EzXO74MaIPYoArkKO6FQh0NiNKRQAP+kEHDQnpB09ZWOy31H6h+OxAHAl75b64cyk8GUR4kbnvL+ypRl7gu8vhqodogQ3niCjYgR2pm+1OLYrtY0fi1vnQ/lBHZD3McY1HKds13G0WSgpIJfuxOK66BcD/JELzXc/+guRNMzUiaOwuMsPYz3qCIrWwKIDkUa5Ah+fpyKv7APgIYYnQTDqOZEnE9Rv5CfN94YqfPbJ+snZQZ+yOsSIowETR7toA0bdZGxBnbBzV4vX0FItJTeivWgAIvPa4Qsr/nm3pPpW4UsGWSyX4CzEpVeIDhrmenEeDDz9zikt9IQdnKe5Z4Q5XgKaAg1WS7R/TEAklOltXqfA3pLQZ9JA5uFrOuPkEk7v8YP951bNIh3ct2Rzi5CI9xAJJbL6CYds0IuCM725lIrJDSFrM8ubVidbs6gTJjgXF+W+ws0oAxZNu6nKoHmz3Ghka/IV0AdX3xzinUVZwNCDiq7HD10jwkU+XIuZhd4dt74pbn235x7gXSi8HsKRsfimVl7MH3ZHSncb1WQpNYaSFD3m6fiPXaGpH1RwKEnrffzAVR8OkElgipr8FUuAX6bo66+WKpMzgBBSRZD9SLRb9a7m/1qtrHLlCpdu2jIkZic98PPqeo6YBxEE7wS1j41jEygWZZIpxWA7T2QzsnI9RyzCownH1bhcWPrXMRSoAyWXBh7rvr40r5/WIGkpUi0CwslZtj3IuFq5WSHWdPCDGwBwNpRRvPsDJnvPfb7fWLosw8zheGja0NBiBpcZIdhyJKLNi5bUxeYZVzb/vVua1tUxeGW6Zi3lMeeij+MFi5mdduzeaPKUT5f8PHWetcn3u+O736vhBOsZ9NC+7h1/gW/bT5xu2v9DARzbsFZGqZL5Co2GfbZ/H3qXfhlmuD6HW8bjBH4sg/XEr+GZMqgx+ALkna3O3FDIKHNeYik6ZbLotCu9DcRTUR0vQnyz6IPAUqXZLdYEhbk4sWdkpb0JyXYXzVDPrqZQoygOgKGScMMUgMRmn97EVeCrufZ2O8U5pBDop2LqGccoTJcLct7NCaekvgbpIKr5muqaPkDaKlZKI9MOn1eVWOlWC2L/Fcn4x3fA1bCYI5M/JsVuAcvncv8f2+nARH/JAg7mXmdUCBvfTAuqzkwufUJR11KS2Ti+2UQ7B/B+eSBhkOIPMKe5Kdl/JYjyF6LplUM4Oi6Pdf7lE0jIrjX4DhIRbHpKeAG38cC997M+LzfrMKxcQGCYF/nfV/v4PTmXi6+7+bMo26SwNv+WmpkWJhjdxrskHMBisIag2eUaUr+8HEWEhZ6vLqQM1o4PnG8xRdQeeYlxNbwqBinI8XbHY7x1HvZYmSRXfKl7N90Oer0+uKJCsKuYhsLUR12pDufI+yFBFTSOilJUB5RGkK5pvqgMry64eXa7jl7YW6jdxjd1Cc6Jh4cKkMyIgdzr
*/