
//          Copyright Oliver Kowalke 2016.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_FIBERS_DETAIL_FUTEX_H
#define BOOST_FIBERS_DETAIL_FUTEX_H

#include <boost/config.hpp>
#include <boost/predef.h> 

#include <boost/fiber/detail/config.hpp>

#ifndef SYS_futex
#define SYS_futex SYS_futex_time64
#endif

#if BOOST_OS_LINUX
extern "C" {
#include <linux/futex.h>
#include <sys/syscall.h>
}
#elif BOOST_OS_WINDOWS
#include <windows.h>
#endif

namespace boost {
namespace fibers {
namespace detail {

#if BOOST_OS_LINUX
BOOST_FORCEINLINE
int sys_futex( void * addr, std::int32_t op, std::int32_t x) {
    return ::syscall( SYS_futex, addr, op, x, nullptr, nullptr, 0);
}

BOOST_FORCEINLINE
int futex_wake( std::atomic< std::int32_t > * addr) {
    return 0 <= sys_futex( static_cast< void * >( addr), FUTEX_WAKE_PRIVATE, 1) ? 0 : -1;
}

BOOST_FORCEINLINE
int futex_wait( std::atomic< std::int32_t > * addr, std::int32_t x) {
    return 0 <= sys_futex( static_cast< void * >( addr), FUTEX_WAIT_PRIVATE, x) ? 0 : -1;
}
#elif BOOST_OS_WINDOWS
BOOST_FORCEINLINE
int futex_wake( std::atomic< std::int32_t > * addr) {
    ::WakeByAddressSingle( static_cast< void * >( addr) );
    return 0;
}

BOOST_FORCEINLINE
int futex_wait( std::atomic< std::int32_t > * addr, std::int32_t x) {
    ::WaitOnAddress( static_cast< volatile void * >( addr), & x, sizeof( x), INFINITE);
    return 0;
}
#else
# warn "no futex support on this platform"
#endif

}}}

#endif // BOOST_FIBERS_DETAIL_FUTEX_H

/* futex.hpp
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
*/