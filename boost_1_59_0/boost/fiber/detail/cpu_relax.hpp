
//          Copyright Oliver Kowalke 2016.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_FIBERS_DETAIL_CPU_RELAX_H
#define BOOST_FIBERS_DETAIL_CPU_RELAX_H

#include <chrono>
#include <thread>

#include <boost/config.hpp>
#include <boost/predef.h> 

#include <boost/fiber/detail/config.hpp>

#if BOOST_COMP_MSVC || BOOST_COMP_MSVC_EMULATED
# include <windows.h>
#endif

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

namespace boost {
namespace fibers {
namespace detail {

#if BOOST_ARCH_ARM
# if BOOST_COMP_MSVC
#  define cpu_relax() YieldProcessor();
# elif (defined(__ARM_ARCH_6K__) || \
        defined(__ARM_ARCH_6Z__) || \
        defined(__ARM_ARCH_6ZK__) || \
        defined(__ARM_ARCH_6T2__) || \
        defined(__ARM_ARCH_7__) || \
        defined(__ARM_ARCH_7A__) || \
        defined(__ARM_ARCH_7R__) || \
        defined(__ARM_ARCH_7M__) || \
        defined(__ARM_ARCH_7S__) || \
        defined(__ARM_ARCH_8A__) || \
        defined(__aarch64__))
// http://groups.google.com/a/chromium.org/forum/#!msg/chromium-dev/YGVrZbxYOlU/Vpgy__zeBQAJ
// mnemonic 'yield' is supported from ARMv6k onwards
#  define cpu_relax() asm volatile ("yield" ::: "memory");
# else
#  define cpu_relax() asm volatile ("nop" ::: "memory");
# endif
#elif BOOST_ARCH_MIPS && (((__mips_isa_rev > 1) && defined(__mips32)) || ((__mips_isa_rev > 2)  && defined(__mips64)))
# define cpu_relax() asm volatile ("pause" ::: "memory");
#elif BOOST_ARCH_PPC
// http://code.metager.de/source/xref/gnu/glibc/sysdeps/powerpc/sys/platform/ppc.h
// http://stackoverflow.com/questions/5425506/equivalent-of-x86-pause-instruction-for-ppc
// mnemonic 'or' shared resource hints
// or 27, 27, 27 This form of 'or' provides a hint that performance
//               will probably be imrpoved if shared resources dedicated
//               to the executing processor are released for use by other
//               processors
// extended mnemonics (available with POWER7)
// yield   ==   or 27, 27, 27
# define cpu_relax() asm volatile ("or 27,27,27" ::: "memory");
#elif BOOST_ARCH_X86
# if BOOST_COMP_MSVC || BOOST_COMP_MSVC_EMULATED
#  define cpu_relax() YieldProcessor();
# else
#  define cpu_relax() asm volatile ("pause" ::: "memory");
# endif
#else
# define cpu_relax() { \
   static constexpr std::chrono::microseconds us0{ 0 }; \
   std::this_thread::sleep_for( us0); \
  }
#endif

}}}

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBERS_DETAIL_CPU_RELAX_H

/* cpu_relax.hpp
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
*/