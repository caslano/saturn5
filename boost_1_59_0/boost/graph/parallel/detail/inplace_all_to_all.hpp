// Copyright 2005 The Trustees of Indiana University.

// Use, modification and distribution is subject to the Boost Software
// License, Version 1.0. (See accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt)

//  Authors: Douglas Gregor
//           Andrew Lumsdaine

#ifndef BOOST_GRAPH_PARALLEL_INPLACE_ALL_TO_ALL_HPP
#define BOOST_GRAPH_PARALLEL_INPLACE_ALL_TO_ALL_HPP

#ifndef BOOST_GRAPH_USE_MPI
#error "Parallel BGL files should not be included unless <boost/graph/use_mpi.hpp> has been included"
#endif

//
// Implements the inplace all-to-all communication algorithm.
//
#include <vector>
#include <iterator>

namespace boost { namespace parallel { 

template<typename ProcessGroup, typename T>
// where {LinearProcessGroup<ProcessGroup>, MessagingProcessGroup<ProcessGroup>}
void 
inplace_all_to_all(ProcessGroup pg, 
                   const std::vector<std::vector<T> >& outgoing,
                   std::vector<std::vector<T> >& incoming)
{
  typedef typename std::vector<T>::size_type size_type;

  typedef typename ProcessGroup::process_size_type process_size_type;
  typedef typename ProcessGroup::process_id_type process_id_type;

  process_size_type p = num_processes(pg);

  // Make sure there are no straggling messages
  synchronize(pg);

  // Send along the count (always) and the data (if count > 0)
  for (process_id_type dest = 0; dest < p; ++dest) {
    if (dest != process_id(pg)) {
      send(pg, dest, 0, outgoing[dest].size());
      if (!outgoing[dest].empty())
        send(pg, dest, 1, &outgoing[dest].front(), outgoing[dest].size());
    }
  }

  // Make sure all of the data gets transferred
  synchronize(pg);

  // Receive the sizes and data
  for (process_id_type source = 0; source < p; ++source) {
    if (source != process_id(pg)) {
      size_type size;
      receive(pg, source, 0, size);
      incoming[source].resize(size);
      if (size > 0)
        receive(pg, source, 1, &incoming[source].front(), size);
    } else if (&incoming != &outgoing) {
      incoming[source] = outgoing[source];
    }
  }
}

template<typename ProcessGroup, typename T>
// where {LinearProcessGroup<ProcessGroup>, MessagingProcessGroup<ProcessGroup>}
void 
inplace_all_to_all(ProcessGroup pg, std::vector<std::vector<T> >& data)
{
  inplace_all_to_all(pg, data, data);
}

} } // end namespace boost::parallel

#endif // BOOST_GRAPH_PARALLEL_INPLACE_ALL_TO_ALL_HPP

/* inplace_all_to_all.hpp
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
*/