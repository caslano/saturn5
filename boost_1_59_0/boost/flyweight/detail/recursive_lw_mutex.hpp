/* Copyright 2006-2013 Joaquin M Lopez Munoz.
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * See http://www.boost.org/libs/flyweight for library home page.
 */

#ifndef BOOST_FLYWEIGHT_DETAIL_RECURSIVE_LW_MUTEX_HPP
#define BOOST_FLYWEIGHT_DETAIL_RECURSIVE_LW_MUTEX_HPP

#if defined(_MSC_VER)
#pragma once
#endif

/* Recursive lightweight mutex. Relies entirely on
 * boost::detail::lightweight_mutex, except in Pthreads, where we
 * explicitly use the PTHREAD_MUTEX_RECURSIVE attribute
 * (lightweight_mutex uses the default mutex type instead).
 */

#include <boost/config.hpp>

#if !defined(BOOST_HAS_PTHREADS)
#include <boost/detail/lightweight_mutex.hpp>
namespace boost{

namespace flyweights{

namespace detail{

typedef boost::detail::lightweight_mutex recursive_lightweight_mutex;

} /* namespace flyweights::detail */

} /* namespace flyweights */

} /* namespace boost */
#else
/* code shamelessly ripped from <boost/detail/lwm_pthreads.hpp> */

#include <boost/assert.hpp>
#include <boost/noncopyable.hpp>
#include <pthread.h>

namespace boost{

namespace flyweights{

namespace detail{

struct recursive_lightweight_mutex:noncopyable
{
  recursive_lightweight_mutex()
  {
    pthread_mutexattr_t attr;
    BOOST_VERIFY(pthread_mutexattr_init(&attr)==0);
    BOOST_VERIFY(pthread_mutexattr_settype(&attr,PTHREAD_MUTEX_RECURSIVE)==0);
    BOOST_VERIFY(pthread_mutex_init(&m_,&attr)==0);
    BOOST_VERIFY(pthread_mutexattr_destroy(&attr)==0);
  }

  ~recursive_lightweight_mutex(){pthread_mutex_destroy(&m_);}

  struct scoped_lock;
  friend struct scoped_lock;
  struct scoped_lock:noncopyable
  {
  public:
    scoped_lock(recursive_lightweight_mutex& m):m_(m.m_)
    {
      BOOST_VERIFY(pthread_mutex_lock(&m_)==0);
    }

    ~scoped_lock(){BOOST_VERIFY(pthread_mutex_unlock(&m_)==0);}

  private:
    pthread_mutex_t& m_;
  };

private:
  pthread_mutex_t m_;
};

} /* namespace flyweights::detail */

} /* namespace flyweights */

} /* namespace boost */
#endif

#endif

/* recursive_lw_mutex.hpp
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
*/