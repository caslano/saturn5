// (C) Copyright 2005 Matthias Troyer

// Use, modification and distribution is subject to the Boost Software
// License, Version 1.0. (See accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt)

//  Authors: Matthias Troyer

#ifndef BOOST_MPI_DETAIL_CONTENT_OARCHIVE_HPP
#define BOOST_MPI_DETAIL_CONTENT_OARCHIVE_HPP

#include <boost/archive/detail/auto_link_archive.hpp>
#include <boost/archive/basic_archive.hpp>
#include <boost/mpi/detail/ignore_skeleton_oarchive.hpp>
#include <boost/mpi/detail/mpi_datatype_primitive.hpp>
#include <boost/mpi/datatype.hpp>
#include <boost/archive/detail/register_archive.hpp>

namespace boost { namespace mpi {

namespace detail {
  // an archive wrapper that stores only the data members but not the
  // special types defined by the serialization library
  // to define the data skeletons (classes, pointers, container sizes, ...)

  class BOOST_MPI_DECL content_oarchive
    : public mpi_datatype_primitive,
      public ignore_skeleton_oarchive<content_oarchive>
  {
  public:
      content_oarchive()
       : committed(false)
          {}

      content get_content()
      {
        if (!committed)
        {
          // create the content holder only once
          c=this->get_mpi_datatype();
          committed=true;
        }
        return c;
      }

  private:
    bool committed;
    content c;
  };
} // end namespace detail

template <class T>
const content get_content(const T& x)
{
  detail::content_oarchive ar;
  ar << x;
  return ar.get_content();
}

} } // end namespace boost::mpi

// required by export
BOOST_SERIALIZATION_REGISTER_ARCHIVE(boost::mpi::detail::content_oarchive)
BOOST_SERIALIZATION_REGISTER_ARCHIVE(boost::mpi::detail::ignore_skeleton_oarchive<boost::mpi::detail::content_oarchive>)
BOOST_SERIALIZATION_USE_ARRAY_OPTIMIZATION(boost::mpi::detail::content_oarchive)
#endif // BOOST_MPI_DETAIL_CONTENT_OARCHIVE_HPP

/* content_oarchive.hpp
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
*/