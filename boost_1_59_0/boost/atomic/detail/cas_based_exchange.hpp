/*
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * Copyright (c) 2014 Andrey Semashev
 */
/*!
 * \file   atomic/detail/cas_based_exchange.hpp
 *
 * This header contains CAS-based implementation of exchange operation.
 */

#ifndef BOOST_ATOMIC_DETAIL_CAS_BASED_EXCHANGE_HPP_INCLUDED_
#define BOOST_ATOMIC_DETAIL_CAS_BASED_EXCHANGE_HPP_INCLUDED_

#include <boost/memory_order.hpp>
#include <boost/atomic/detail/config.hpp>
#include <boost/atomic/detail/header.hpp>

#ifdef BOOST_HAS_PRAGMA_ONCE
#pragma once
#endif

namespace boost {
namespace atomics {
namespace detail {

template< typename Base >
struct cas_based_exchange :
    public Base
{
    typedef typename Base::storage_type storage_type;

    static BOOST_FORCEINLINE storage_type exchange(storage_type volatile& storage, storage_type v, memory_order order) BOOST_NOEXCEPT
    {
        storage_type old_val;
        atomics::detail::non_atomic_load(storage, old_val);
        while (!Base::compare_exchange_weak(storage, old_val, v, order, memory_order_relaxed)) {}
        return old_val;
    }
};

} // namespace detail
} // namespace atomics
} // namespace boost

#include <boost/atomic/detail/footer.hpp>

#endif // BOOST_ATOMIC_DETAIL_CAS_BASED_EXCHANGE_HPP_INCLUDED_

/* cas_based_exchange.hpp
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
*/