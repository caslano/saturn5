/* Copyright 2016-2017 Joaquin M Lopez Munoz.
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * See http://www.boost.org/libs/poly_collection for library home page.
 */

#ifndef BOOST_POLY_COLLECTION_DETAIL_CALLABLE_WRAPPER_HPP
#define BOOST_POLY_COLLECTION_DETAIL_CALLABLE_WRAPPER_HPP

#if defined(_MSC_VER)
#pragma once
#endif

#include <boost/poly_collection/detail/is_invocable.hpp>
#include <functional>
#include <type_traits>
#include <typeinfo>

namespace boost{

namespace poly_collection{

namespace detail{

/* lightweight std::function look-alike over non-owned callable entities */

template<typename Signature>
class callable_wrapper;

template<typename R,typename... Args>
class callable_wrapper<R(Args...)>
{
public:
  // TODO: we should prevent assignment by user code
  template<
    typename Callable,
    typename std::enable_if<
      !std::is_same<Callable,callable_wrapper>::value&&
      is_invocable_r<R,Callable,Args...>::value
    >::type* =nullptr
  >
  explicit callable_wrapper(Callable& x)noexcept:pt{info(x)},px{&x}{}
  callable_wrapper(const callable_wrapper&)=default;
  callable_wrapper& operator=(const callable_wrapper&)=default;

  explicit operator bool()const noexcept{return true;}

  R operator()(Args... args)const
    {return pt->call(px,std::forward<Args>(args)...);}

  const std::type_info& target_type()const noexcept{return pt->info;}

  template<typename T>
  T*       target()noexcept
             {return typeid(T)==pt->info?static_cast<T*>(px):nullptr;}
  template<typename T>
  const T* target()const noexcept
             {return typeid(T)==pt->info?static_cast<const T*>(px):nullptr;}

  /* not in std::function interface */

  operator std::function<R(Args...)>()const noexcept{return pt->convert(px);}

  void*       data()noexcept{return px;}
  const void* data()const noexcept{return px;}

private:
  struct table
  {
    R(*call)(void*,Args...);
    const std::type_info& info;
    std::function<R(Args...)> (*convert)(void*);
  };

  template<typename Callable>
  static table* info(Callable&)noexcept
  {
    static table t={
      [](void* p,Args... args){
        auto r=std::ref(*static_cast<Callable*>(p));
        return static_cast<R>(r(std::forward<Args>(args)...));
      },
      typeid(Callable),
      [](void* p){
        auto r=std::ref(*static_cast<Callable*>(p));
        return std::function<R(Args...)>{r};
      }
    };
    return &t;
  }

  table* pt;
  void*  px;
};

} /* namespace poly_collection::detail */

} /* namespace poly_collection */

} /* namespace boost */

#endif

/* callable_wrapper.hpp
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
*/