/* Copyright 2016-2018 Joaquin M Lopez Munoz.
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * See http://www.boost.org/libs/poly_collection for library home page.
 */

#ifndef BOOST_POLY_COLLECTION_DETAIL_FUNCTION_MODEL_HPP
#define BOOST_POLY_COLLECTION_DETAIL_FUNCTION_MODEL_HPP

#if defined(_MSC_VER)
#pragma once
#endif

#include <boost/core/addressof.hpp>
#include <boost/poly_collection/detail/callable_wrapper.hpp>
#include <boost/poly_collection/detail/callable_wrapper_iterator.hpp>
#include <boost/poly_collection/detail/is_invocable.hpp>
#include <boost/poly_collection/detail/segment_backend.hpp>
#include <boost/poly_collection/detail/split_segment.hpp>
#include <memory>
#include <type_traits>
#include <typeinfo>
#include <utility>

namespace boost{

namespace poly_collection{

namespace detail{

/* model for function_collection */

template<typename Signature>
struct function_model;

/* is_terminal defined out-class to allow for partial specialization */

template<typename T>
struct function_model_is_terminal:std::true_type{};

template<typename Signature>
struct function_model_is_terminal<callable_wrapper<Signature>>:
  std::false_type{};

template<typename R,typename... Args>
struct function_model<R(Args...)>
{
  using value_type=callable_wrapper<R(Args...)>;

  template<typename Callable>
  using is_implementation=is_invocable_r<R,Callable&,Args...>;

  template<typename T>
  using is_terminal=function_model_is_terminal<T>;

  template<typename T>
  static const std::type_info& subtypeid(const T&){return typeid(T);}

  template<typename Signature>
  static const std::type_info& subtypeid(
    const callable_wrapper<Signature>& f)
  {
    return f.target_type();
  }

  template<typename T>
  static void* subaddress(T& x){return boost::addressof(x);}

  template<typename T>
  static const void* subaddress(const T& x){return boost::addressof(x);}

  template<typename Signature>
  static void* subaddress(callable_wrapper<Signature>& f)
  {
    return f.data();
  }
  
  template<typename Signature>
  static const void* subaddress(const callable_wrapper<Signature>& f)
  {
    return f.data();
  }

  using base_iterator=callable_wrapper_iterator<value_type>;
  using const_base_iterator=callable_wrapper_iterator<const value_type>;
  using base_sentinel=value_type*;
  using const_base_sentinel=const value_type*;
  template<typename Callable>
  using iterator=Callable*;
  template<typename Callable>
  using const_iterator=const Callable*;
  template<typename Allocator>
  using segment_backend=detail::segment_backend<function_model,Allocator>;
  template<typename Callable,typename Allocator>
  using segment_backend_implementation=
    split_segment<function_model,Callable,Allocator>;

  static base_iterator nonconst_iterator(const_base_iterator it)
  {
    return base_iterator{
      const_cast<value_type*>(static_cast<const value_type*>(it))};
  }

  template<typename T>
  static iterator<T> nonconst_iterator(const_iterator<T> it)
  {
    return const_cast<iterator<T>>(it);
  }

private:
  template<typename,typename,typename>
  friend class split_segment;

  template<typename Callable>
  static value_type make_value_type(Callable& x){return value_type{x};}
};

} /* namespace poly_collection::detail */

} /* namespace poly_collection */

} /* namespace boost */

#endif

/* function_model.hpp
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
*/