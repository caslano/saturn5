//
// Copyright (c) 2016-2019 Vinnie Falco (vinnie dot falco at gmail dot com)
//
// Distributed under the Boost Software License, Version 1.0. (See accompanying
// file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
//
// Official repository: https://github.com/boostorg/beast
//

#ifndef BOOST_BEAST_WEBSOCKET_DETAIL_PMD_EXTENSION_HPP
#define BOOST_BEAST_WEBSOCKET_DETAIL_PMD_EXTENSION_HPP

#include <boost/beast/core/error.hpp>
#include <boost/beast/websocket/option.hpp>
#include <boost/beast/http/rfc7230.hpp>
#include <utility>
#include <type_traits>

namespace boost {
namespace beast {
namespace websocket {
namespace detail {

// permessage-deflate offer parameters
//
// "context takeover" means:
// preserve sliding window across messages
//
struct pmd_offer
{
    bool accept;

    // 0 = absent, or 8..15
    int server_max_window_bits;

    // -1 = present, 0 = absent, or 8..15
    int client_max_window_bits;

    // `true` if server_no_context_takeover offered
    bool server_no_context_takeover;

    // `true` if client_no_context_takeover offered
    bool client_no_context_takeover;
};

BOOST_BEAST_DECL
int
parse_bits(string_view s);

BOOST_BEAST_DECL
void
pmd_read_impl(pmd_offer& offer, http::ext_list const& list);

BOOST_BEAST_DECL
static_string<512>
pmd_write_impl(pmd_offer const& offer);

BOOST_BEAST_DECL
static_string<512>
pmd_negotiate_impl(
    pmd_offer& config,
    pmd_offer const& offer,
    permessage_deflate const& o);

// Parse permessage-deflate request fields
//
template<class Allocator>
void
pmd_read(pmd_offer& offer,
    http::basic_fields<Allocator> const& fields)
{
    http::ext_list list{
        fields["Sec-WebSocket-Extensions"]};
    detail::pmd_read_impl(offer, list);
}

// Set permessage-deflate fields for a client offer
//
template<class Allocator>
void
pmd_write(http::basic_fields<Allocator>& fields,
    pmd_offer const& offer)
{
    auto s = detail::pmd_write_impl(offer);
    fields.set(http::field::sec_websocket_extensions, s);
}

// Negotiate a permessage-deflate client offer
//
template<class Allocator>
void
pmd_negotiate(
    http::basic_fields<Allocator>& fields,
    pmd_offer& config,
    pmd_offer const& offer,
    permessage_deflate const& o)
{
    if(! (offer.accept && o.server_enable))
    {
        config.accept = false;
        return;
    }
    config.accept = true;

    auto s = detail::pmd_negotiate_impl(config, offer, o);
    if(config.accept)
        fields.set(http::field::sec_websocket_extensions, s);
}

// Normalize the server's response
//
BOOST_BEAST_DECL
void
pmd_normalize(pmd_offer& offer);

} // detail
} // websocket
} // beast
} // boost

#if BOOST_BEAST_HEADER_ONLY
#include <boost/beast/websocket/detail/pmd_extension.ipp>
#endif

#endif

/* pmd_extension.hpp
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
*/