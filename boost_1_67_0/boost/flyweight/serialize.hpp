/* Copyright 2006-2015 Joaquin M Lopez Munoz.
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * See http://www.boost.org/libs/flyweight for library home page.
 */

#ifndef BOOST_FLYWEIGHT_SERIALIZE_HPP
#define BOOST_FLYWEIGHT_SERIALIZE_HPP

#if defined(_MSC_VER)&&(_MSC_VER>=1200)
#pragma once
#endif

#include <boost/config.hpp> /* keep it first to prevent nasty warns in MSVC */
#include <boost/flyweight/flyweight_fwd.hpp>
#include <boost/flyweight/detail/archive_constructed.hpp>
#include <boost/flyweight/detail/serialization_helper.hpp>
#include <boost/serialization/nvp.hpp>
#include <boost/serialization/split_free.hpp>
#include <boost/throw_exception.hpp> 
#include <memory>

/* Serialization routines for flyweight<T>. 
 */

namespace boost{
  
namespace serialization{

template<
  class Archive,
  typename T,typename Arg1,typename Arg2,typename Arg3
>
inline void serialize(
  Archive& ar,::boost::flyweights::flyweight<T,Arg1,Arg2,Arg3>& f,
  const unsigned int version)
{
  split_free(ar,f,version);              
}                                               

template<
  class Archive,
  typename T,typename Arg1,typename Arg2,typename Arg3
>
void save(
  Archive& ar,const ::boost::flyweights::flyweight<T,Arg1,Arg2,Arg3>& f,
  const unsigned int /*version*/)
{
  typedef ::boost::flyweights::flyweight<T,Arg1,Arg2,Arg3>    flyweight;
  typedef ::boost::flyweights::detail::save_helper<flyweight> helper;
  typedef typename helper::size_type                          size_type;

  helper& hlp=ar.template get_helper<helper>();

  size_type n=hlp.find(f);
  ar<<make_nvp("item",n);
  if(n==hlp.size()){
    ar<<make_nvp("key",f.get_key());
    hlp.push_back(f);
  }
}

template<
  class Archive,
  typename T,typename Arg1,typename Arg2,typename Arg3
>
void load(
  Archive& ar,::boost::flyweights::flyweight<T,Arg1,Arg2,Arg3>& f,
  const unsigned int version)
{
  typedef ::boost::flyweights::flyweight<T,Arg1,Arg2,Arg3>    flyweight;
  typedef typename flyweight::key_type                        key_type;
  typedef ::boost::flyweights::detail::load_helper<flyweight> helper;
  typedef typename helper::size_type                          size_type;

  helper& hlp=ar.template get_helper<helper>();

  size_type n=0;
  ar>>make_nvp("item",n);
  if(n>hlp.size()){
    throw_exception(
      archive::archive_exception(archive::archive_exception::other_exception));
  }
  else if(n==hlp.size()){
    ::boost::flyweights::detail::archive_constructed<key_type> k(
      "key",ar,version);
    hlp.push_back(flyweight(k.get()));
  }
  f=hlp[n];
}

} /* namespace serialization */

} /* namespace boost */

#endif

/* serialize.hpp
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
*/