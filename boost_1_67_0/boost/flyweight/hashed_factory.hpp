/* Copyright 2006-2014 Joaquin M Lopez Munoz.
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * See http://www.boost.org/libs/flyweight for library home page.
 */

#ifndef BOOST_FLYWEIGHT_HASHED_FACTORY_HPP
#define BOOST_FLYWEIGHT_HASHED_FACTORY_HPP

#if defined(_MSC_VER)
#pragma once
#endif

#include <boost/config.hpp> /* keep it first to prevent nasty warns in MSVC */
#include <boost/flyweight/factory_tag.hpp>
#include <boost/flyweight/hashed_factory_fwd.hpp>
#include <boost/multi_index_container.hpp>
#include <boost/multi_index/identity.hpp>
#include <boost/multi_index/hashed_index.hpp>
#include <boost/mpl/aux_/lambda_support.hpp>
#include <boost/mpl/if.hpp>

#if !defined(BOOST_NO_CXX11_RVALUE_REFERENCES)
#include <utility>
#endif

/* Flyweight factory based on a hashed container implemented
 * with Boost.MultiIndex.
 */

namespace boost{

namespace flyweights{

template<
  typename Entry,typename Key,
  typename Hash,typename Pred,typename Allocator
>
class hashed_factory_class:public factory_marker
{
  struct index_list:
    boost::mpl::vector1<
      multi_index::hashed_unique<
        multi_index::identity<Entry>,
        typename boost::mpl::if_<
          mpl::is_na<Hash>,
          hash<Key>,
          Hash
        >::type,
        typename boost::mpl::if_<
          mpl::is_na<Pred>,
          std::equal_to<Key>,
          Pred
        >::type
      >
    >
  {};

  typedef multi_index::multi_index_container<
    Entry,
    index_list,
    typename boost::mpl::if_<
      mpl::is_na<Allocator>,
      std::allocator<Entry>,
      Allocator
    >::type
  > container_type;

public:
  typedef const Entry* handle_type;
  
  handle_type insert(const Entry& x)
  {
    return &*cont.insert(x).first;
  }

#if !defined(BOOST_NO_CXX11_RVALUE_REFERENCES)
  handle_type insert(Entry&& x)
  {
    return &*cont.insert(std::move(x)).first;
  }
#endif

  void erase(handle_type h)
  {
    cont.erase(cont.iterator_to(*h));
  }

  static const Entry& entry(handle_type h){return *h;}

private:  
  container_type cont;

public:
  typedef hashed_factory_class type;
  BOOST_MPL_AUX_LAMBDA_SUPPORT(
    5,hashed_factory_class,(Entry,Key,Hash,Pred,Allocator))
};

/* hashed_factory_class specifier */

template<
  typename Hash,typename Pred,typename Allocator
  BOOST_FLYWEIGHT_NOT_A_PLACEHOLDER_EXPRESSION_DEF
>
struct hashed_factory:factory_marker
{
  template<typename Entry,typename Key>
  struct apply:
    mpl::apply2<
      hashed_factory_class<
        boost::mpl::_1,boost::mpl::_2,Hash,Pred,Allocator
      >,
      Entry,Key
    >
  {};
};

} /* namespace flyweights */

} /* namespace boost */

#endif

/* hashed_factory.hpp
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
*/