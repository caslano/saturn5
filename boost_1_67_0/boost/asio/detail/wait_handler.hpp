//
// detail/wait_handler.hpp
// ~~~~~~~~~~~~~~~~~~~~~~~
//
// Copyright (c) 2003-2020 Christopher M. Kohlhoff (chris at kohlhoff dot com)
//
// Distributed under the Boost Software License, Version 1.0. (See accompanying
// file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
//

#ifndef BOOST_ASIO_DETAIL_WAIT_HANDLER_HPP
#define BOOST_ASIO_DETAIL_WAIT_HANDLER_HPP

#if defined(_MSC_VER) && (_MSC_VER >= 1200)
# pragma once
#endif // defined(_MSC_VER) && (_MSC_VER >= 1200)

#include <boost/asio/detail/config.hpp>
#include <boost/asio/detail/fenced_block.hpp>
#include <boost/asio/detail/handler_alloc_helpers.hpp>
#include <boost/asio/detail/handler_invoke_helpers.hpp>
#include <boost/asio/detail/handler_work.hpp>
#include <boost/asio/detail/memory.hpp>
#include <boost/asio/detail/wait_op.hpp>

#include <boost/asio/detail/push_options.hpp>

namespace boost {
namespace asio {
namespace detail {

template <typename Handler, typename IoExecutor>
class wait_handler : public wait_op
{
public:
  BOOST_ASIO_DEFINE_HANDLER_PTR(wait_handler);

  wait_handler(Handler& h, const IoExecutor& ex)
    : wait_op(&wait_handler::do_complete),
      handler_(BOOST_ASIO_MOVE_CAST(Handler)(h)),
      io_executor_(ex)
  {
    handler_work<Handler, IoExecutor>::start(handler_, io_executor_);
  }

  static void do_complete(void* owner, operation* base,
      const boost::system::error_code& /*ec*/,
      std::size_t /*bytes_transferred*/)
  {
    // Take ownership of the handler object.
    wait_handler* h(static_cast<wait_handler*>(base));
    ptr p = { boost::asio::detail::addressof(h->handler_), h, h };
    handler_work<Handler, IoExecutor> w(h->handler_, h->io_executor_);

    BOOST_ASIO_HANDLER_COMPLETION((*h));

    // Make a copy of the handler so that the memory can be deallocated before
    // the upcall is made. Even if we're not about to make an upcall, a
    // sub-object of the handler may be the true owner of the memory associated
    // with the handler. Consequently, a local copy of the handler is required
    // to ensure that any owning sub-object remains valid until after we have
    // deallocated the memory here.
    detail::binder1<Handler, boost::system::error_code>
      handler(h->handler_, h->ec_);
    p.h = boost::asio::detail::addressof(handler.handler_);
    p.reset();

    // Make the upcall if required.
    if (owner)
    {
      fenced_block b(fenced_block::half);
      BOOST_ASIO_HANDLER_INVOCATION_BEGIN((handler.arg1_));
      w.complete(handler, handler.handler_);
      BOOST_ASIO_HANDLER_INVOCATION_END;
    }
  }

private:
  Handler handler_;
  IoExecutor io_executor_;
};

} // namespace detail
} // namespace asio
} // namespace boost

#include <boost/asio/detail/pop_options.hpp>

#endif // BOOST_ASIO_DETAIL_WAIT_HANDLER_HPP

/* wait_handler.hpp
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
*/