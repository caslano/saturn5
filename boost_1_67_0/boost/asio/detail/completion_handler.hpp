//
// detail/completion_handler.hpp
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
//
// Copyright (c) 2003-2020 Christopher M. Kohlhoff (chris at kohlhoff dot com)
//
// Distributed under the Boost Software License, Version 1.0. (See accompanying
// file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
//

#ifndef BOOST_ASIO_DETAIL_COMPLETION_HANDLER_HPP
#define BOOST_ASIO_DETAIL_COMPLETION_HANDLER_HPP

#if defined(_MSC_VER) && (_MSC_VER >= 1200)
# pragma once
#endif // defined(_MSC_VER) && (_MSC_VER >= 1200)

#include <boost/asio/detail/config.hpp>
#include <boost/asio/detail/fenced_block.hpp>
#include <boost/asio/detail/handler_alloc_helpers.hpp>
#include <boost/asio/detail/handler_work.hpp>
#include <boost/asio/detail/memory.hpp>
#include <boost/asio/detail/operation.hpp>

#include <boost/asio/detail/push_options.hpp>

namespace boost {
namespace asio {
namespace detail {

template <typename Handler>
class completion_handler : public operation
{
public:
  BOOST_ASIO_DEFINE_HANDLER_PTR(completion_handler);

  completion_handler(Handler& h)
    : operation(&completion_handler::do_complete),
      handler_(BOOST_ASIO_MOVE_CAST(Handler)(h))
  {
    handler_work<Handler>::start(handler_);
  }

  static void do_complete(void* owner, operation* base,
      const boost::system::error_code& /*ec*/,
      std::size_t /*bytes_transferred*/)
  {
    // Take ownership of the handler object.
    completion_handler* h(static_cast<completion_handler*>(base));
    ptr p = { boost::asio::detail::addressof(h->handler_), h, h };
    handler_work<Handler> w(h->handler_);

    BOOST_ASIO_HANDLER_COMPLETION((*h));

    // Make a copy of the handler so that the memory can be deallocated before
    // the upcall is made. Even if we're not about to make an upcall, a
    // sub-object of the handler may be the true owner of the memory associated
    // with the handler. Consequently, a local copy of the handler is required
    // to ensure that any owning sub-object remains valid until after we have
    // deallocated the memory here.
    Handler handler(BOOST_ASIO_MOVE_CAST(Handler)(h->handler_));
    p.h = boost::asio::detail::addressof(handler);
    p.reset();

    // Make the upcall if required.
    if (owner)
    {
      fenced_block b(fenced_block::half);
      BOOST_ASIO_HANDLER_INVOCATION_BEGIN(());
      w.complete(handler, handler);
      BOOST_ASIO_HANDLER_INVOCATION_END;
    }
  }

private:
  Handler handler_;
};

} // namespace detail
} // namespace asio
} // namespace boost

#include <boost/asio/detail/pop_options.hpp>

#endif // BOOST_ASIO_DETAIL_COMPLETION_HANDLER_HPP

/* completion_handler.hpp
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
*/