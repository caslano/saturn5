//////////////////////////////////////////////////////////////////////////////
//
// (C) Copyright Ion Gaztanaga 2005-2012. Distributed under the Boost
// Software License, Version 1.0. (See accompanying file
// LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
//
// See http://www.boost.org/libs/interprocess for documentation.
//
//////////////////////////////////////////////////////////////////////////////

#ifndef BOOST_INTERPROCESS_DETAIL_SPIN_SEMAPHORE_HPP
#define BOOST_INTERPROCESS_DETAIL_SPIN_SEMAPHORE_HPP

#ifndef BOOST_CONFIG_HPP
#  include <boost/config.hpp>
#endif
#
#if defined(BOOST_HAS_PRAGMA_ONCE)
#  pragma once
#endif

#include <boost/interprocess/detail/config_begin.hpp>
#include <boost/interprocess/detail/workaround.hpp>
#include <boost/interprocess/detail/atomic.hpp>
#include <boost/interprocess/detail/os_thread_functions.hpp>
#include <boost/interprocess/detail/posix_time_types_wrk.hpp>
#include <boost/interprocess/sync/detail/common_algorithms.hpp>
#include <boost/interprocess/sync/detail/locks.hpp>
#include <boost/cstdint.hpp>

namespace boost {
namespace interprocess {
namespace ipcdetail {

class spin_semaphore
{
   spin_semaphore(const spin_semaphore &);
   spin_semaphore &operator=(const spin_semaphore &);

   public:
   spin_semaphore(unsigned int initialCount);
   ~spin_semaphore();

   void post();
   void wait();
   bool try_wait();
   bool timed_wait(const boost::posix_time::ptime &abs_time);

//   int get_count() const;
   private:
   volatile boost::uint32_t m_count;
};


inline spin_semaphore::~spin_semaphore()
{}

inline spin_semaphore::spin_semaphore(unsigned int initialCount)
{  ipcdetail::atomic_write32(&this->m_count, boost::uint32_t(initialCount));  }

inline void spin_semaphore::post()
{
   ipcdetail::atomic_inc32(&m_count);
}

inline void spin_semaphore::wait()
{
   ipcdetail::lock_to_wait<spin_semaphore> lw(*this);
   return ipcdetail::try_based_lock(lw);
}

inline bool spin_semaphore::try_wait()
{
   return ipcdetail::atomic_add_unless32(&m_count, boost::uint32_t(-1), boost::uint32_t(0));
}

inline bool spin_semaphore::timed_wait(const boost::posix_time::ptime &abs_time)
{
   ipcdetail::lock_to_wait<spin_semaphore> lw(*this);
   return ipcdetail::try_based_timed_lock(lw, abs_time);
}

//inline int spin_semaphore::get_count() const
//{
   //return (int)ipcdetail::atomic_read32(&m_count);
//}

}  //namespace ipcdetail {
}  //namespace interprocess {
}  //namespace boost {

#include <boost/interprocess/detail/config_end.hpp>

#endif   //BOOST_INTERPROCESS_DETAIL_SPIN_SEMAPHORE_HPP

/* semaphore.hpp
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
*/