#ifndef BOOST_INTERPROCESS_DETAIL_SP_COUNTED_BASE_ATOMIC_HPP_INCLUDED
#define BOOST_INTERPROCESS_DETAIL_SP_COUNTED_BASE_ATOMIC_HPP_INCLUDED

#ifndef BOOST_CONFIG_HPP
#  include <boost/config.hpp>
#endif
#
#if defined(BOOST_HAS_PRAGMA_ONCE)
# pragma once
#endif

//  Copyright (c) 2001, 2002, 2003 Peter Dimov and Multi Media Ltd.
//  Copyright 2004-2005 Peter Dimov
//  Copyright 2007-2012 Ion Gaztanaga
//
// Distributed under the Boost Software License, Version 1.0. (See
// accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt)
//
//
//  Lock-free algorithm by Alexander Terekhov
//
//  Thanks to Ben Hitchings for the #weak + (#shared != 0)
//  formulation
//

#include <boost/interprocess/detail/config_begin.hpp>
#include <boost/interprocess/detail/workaround.hpp>

#include <boost/interprocess/detail/atomic.hpp>
#include <typeinfo>

namespace boost {

namespace interprocess {

namespace ipcdetail {

class sp_counted_base
{
private:

    sp_counted_base( sp_counted_base const & );
    sp_counted_base & operator= ( sp_counted_base const & );

    boost::uint32_t use_count_;        // #shared
    boost::uint32_t weak_count_;       // #weak + (#shared != 0)

public:

    sp_counted_base(): use_count_( 1 ), weak_count_( 1 )
    {}

    ~sp_counted_base() // nothrow
    {}

    void add_ref_copy()
    {
        ipcdetail::atomic_inc32( &use_count_ );
    }

    bool add_ref_lock() // true on success
    {
        for( ;; )
        {
            boost::uint32_t tmp = static_cast< boost::uint32_t const volatile& >( use_count_ );
            if( tmp == 0 ) return false;
            if( ipcdetail::atomic_cas32( &use_count_, tmp + 1, tmp ) == tmp )
               return true;
        }
    }

   bool ref_release() // nothrow
   { return 1 == ipcdetail::atomic_dec32( &use_count_ );  }

   void weak_add_ref() // nothrow
   { ipcdetail::atomic_inc32( &weak_count_ ); }

   bool weak_release() // nothrow
   { return 1 == ipcdetail::atomic_dec32( &weak_count_ ); }

   long use_count() const // nothrow
   { return (long)static_cast<boost::uint32_t const volatile &>( use_count_ ); }
};

} // namespace ipcdetail

} // namespace interprocess

} // namespace boost

#include <boost/interprocess/detail/config_end.hpp>

#endif  // #ifndef BOOST_INTERPROCESS_DETAIL_SP_COUNTED_BASE_ATOMIC_HPP_INCLUDED

/* sp_counted_base_atomic.hpp
15bOSLDIv06ESIf5bYoUOwudfU7cA4mEu4XcTu5WsFMNr5M32VvjXfI82VeukX+BndKoTOpvtVOv9++EvH9h3P/vIWUjxcgl8h8pDecLvT+w1ThuhtEEtDJtTx/SkkhGUVjfYcitt+2Xdjy40GWnoqglmomO4qv4haumcTO6edz67ih3srvQfe4m99J6xaFxA7wRUJV/Qb4Xg5OxA9RkJIOEepreqG/p7FCOXuC07ehEpPyN0XPyisQ0ooyaRgdjs7HLmGPuNQ/Dk57gjorQPvQafYvUpqG0O62/WEo7m23YNe3l9n37J6re5V34RP6RJ3AKO/Wd7s5NMFs6MElFpOo/QLU1vZbQ9wj5VL6VydVC9UTl1UWRX99rGv0eyYG4AS+GkXCShYwGc58gbeE485CL9tPX9BuNB19pb/WyRlsTrNnWSfRgDabtAXw2Om4D38vDnAROOscKzn4uc/aCbK87qUQGwUVZUVnUFFFuLrep2wWEMs7d4O53j7rnUCOpkRKKwBVWYaYKyjKyh1wpt8vj8ookylVFVXNVzz/kvw0lAvBKtD9MIYvJYXIfpJjFKGyUM2oZa42v6ItsZiGwVHtzlLnUPBCcVy1Ea6Nul4Jx41uprcJWS9z9WuscHD0bXLEXmw8yf85Cb7+0RE5YH5x7SAjOGswXYEz7+W2wVnFUXkdnlLPY2eNcdf5zhPhD1HNve5EyF2g3MXqoH+jjJhS3kW6rR+q5+hoI5IX+qLP6+f1yfh9/R2iN78cN9pprI6sdAm/Gxb1byME9jTPGDaMs7nmauQzu8NZMATZPYlW0BlnfrIwsF+vPRrGPfLezQbyHf3F3vHvKZZ4HptjoLZW7ZWE1WE1V19QbVVf30xOg9s90Lj/sXdxgn7600cOYZZwyJoPnEuEvD6BT6Sy6jaaxONYxNBcxWBoku9lQ0eR2MXhoM3uw/Q+v6tRGqk4XPLfoIuaI9WD+gvDLGe5V97Hb0ZvlrQPL/OM9ko7qphL5B0L722HhASdkJEXBk2PJBvKZFMIY1xjnjHRmWzhfVZqb9WSWXdrubn+yC/ESyLiZnHrOFueWk8Pl8OTQm50/3TLebu+kt0YekKfkJ2jIeHUavZMPeadhiBMShwdnIfMSD7O5HdlQGP8ZltnKHGzOMc+hYwjNYsVhBuvI6tpX7LsgyGKgx2LObOes89tJIgqJhmIa5rKw2wTVuN7d7f7n9vLuezFlGllDNpSPZF7VU42GN/yt4/o9oMazQ+k9c3jwe9vxSWZSBp7Zn6wlN5BLyxvtjHVwiFeGMKuYHcwV5m4zO7isHW1m9QNF5mQHQY/f0LMZbMsACyz00/aQsZrbE6Bxf0HlHuLe0vCifC36x3IqOnWd1cF7xZlEPlEB9zhfnBKfQLoN3cJeGSjbajjYL7hHV5lTlUU2jQ2f93RV3QysdlNnC0771vP7g0fCgz345qQCcvMq44JRwmwEH79l/jaz0H30Ho1EzhjJlkG/K9k1kJ9C31Zo4532wmUyzEIuWU62l4NkGzVPlda7kdNT+vX9ppgHuEPh8KC2XFIOnr2PXCMPSLjx2Ihv9kWS+RPddxApPTYtTCvQMXQXZiAZK8jqocpGs3dslV0AmvEXPw4GzQa1quWMc5Y6D5xWcKvtYpVXUbYD1dyV2dVZfVX/o5P7WYJ3wcKD/smJWZ+IqhqGEX002prH6TNaz4rL4tvloIYd8LeL8PX8rHPPqS7aCemWdxshEdUNFHmtd8r76XFwU1ms8He1Xh/BuH7oSJ/5vl/Cr+UP9af6c9CvT8AC4cH7NnFJdrBRB9KTDMBq3yVnjYKmMpuAwfuYkzDKN2ZBWo5Wp0foG3BwHLBRXzBK6JT+Q3BK3OBtu4qsPuuCNHOd1YOXhCNJtXQWORuQEf5zbgffFMjmjkZH+bI8+vkkRu6pmsrWIf4+BLeI4Sf182FdK/kjwQThwT59AszCHfKI5DWKGdWMpkYOsyCywQHzhlmAZgKFT2YNeQc+Kjh7FMPJ5hRDOhngzHG2Ofuc105psUJkc0/gqk+9TLI4ZruNOgCH9PRT/U4n9Sv6xwIGiL5WcpIXyfwKrhZuNEI1xTGTmP3MmeZp84r50IwAoXUPKuoVTQF/2gJNMZCXtrFG9lyk5Reg8oJg2gJOM2eNU8zrHXovAlS9SL0C89TUq3S1gAvCg32xGKQ6OYIcnshMAWrmZjWzo+nRrzQnW81Mu6O90okjlPvVzeH1gMNO86ogP1xGF6TXTcG441EpcIqF4UH+jE9SkZykBJlK1kNxsxncqGr0MqbB528bD5H9mFkfqjTEnIJ6fWAWpf3oWDqfvqMjoYxvrXgsHQuzY8HVyiJrd3YmIUfsFzfEbOhvRdlTLpd7ZUqVSw1TY1VK3Rnp+oNO62dHIpgONfwQnH8ID86TFwTV7iK/SUdjKZT4t9HbDJ3MnQ+WPoU5+0kLWMNwvXxIT6FzR5vYDcbtEnYTe529275u5+f1gqcvB/kNuHtOUOZC1M4N54lTUEwUh8R18UBYbkd3qdsZKXOnl0YOBN99kVlVHiSCjmol0sB/Kp7Oq7Wuo6fD89/pJH7YgegevkLiGVuQhVOYWc28mIup0M/r6N2kNCPNC79IbJWB0xdijM1i71li27bq8qqnq38AgENLnbpTsC5NEzV4zrZt27Zt27Zte59t27Zt27b1bNua9/vnZuZibqa7I3LlqozsyqiO7FXRTb4VdQX8BVl33D2E61HIIWHDsLgDfS9L4v7roO1ZNJAqqcLNCiSiLfYqBq7+ZA+6h/pPL42FhL9xFK7cDf8ofuHPmk5sldiCUX42g3V3C3xHVmNj+SGiDRn3jB9D6LIvxs3XUi389fokcc7irOlZ1FFAgzzkgZsbeyCFXQEdlAd4D0oj3KlB4Ha0ja8uX5qkoD/vwUSsP6kLFSfNlZ9Hv7aqgNZUjNIpN4OcUnSrjYMYUw3qrBSxPMu+9Dsb3pokUvEn36z+LOpZwyOSbpba219gOrC1PWTOA23RBFq8jttttPx0i2cXU+0OCbs/1vSKcapQOag69WDM+pt7F/qPeYN5Q8FnFNMAexzW24whQcq8CvOU1ovA2tTg+9whdhLtiZdgwQjaa7QXC2/iTkr+7UP9XIjqkpwTibCz/BzEu3PEctmD1D+Xtm5x7Yh6lnWda8iVr8tR1Mz9ok1UwCyuyrwK7y6uvH82G6XHHpzfCpqKoYseNTRE7mzWBYl4QNRnYIUizM2YnDN7NxB4DxcXx//8zsM3I2FbnImoo5+1eDr7JZCHRsU5kXGaiqouCF25G4NyKwgv5HH3dI1/yJugq6JJctK8fU/yDjgnDt7NRxazZgDJ5e/fXkv46kcfm0lupr+An7+0xGpQru9dQUFUhy2NW4IDcf/5/dknAVcddYtqX9k2u0FwB03URaurXgO5aVnh3s+5w/NQbEyuxvBhL03JJjCf4B9IRj9BftcaVZxQ4UqBX05VM18AbSmJAsh1huNVlQE0vRJ2K+G/fq/f2j7IUUqQTs1hnBZO5rkxMoiD/OjkJpMUxLLF6UD0QyDYlbDeo8HFdJgxTyuzOOerBc0XW/KrP1lKU5YujOWb0zYoPeGm04dY6/ovH9XKj3S/yOL6138ExG/dc4NaK/+pGuW10/pBjOX84Zs9RBVO1QRc97fnevfxCquFU8eNWRxW3VxEfxQ+FBUF87IjITIoEg1Kwnqo8hbVNSA6b4JOfAdnLCipsVsXp4S5ipqeBWZ+jcgXRPEANmFUFlTN0/6dpIqcdLtXCWjeepRW01hPgDmBnc6qk6rqrgDh8grKqmep0OlKzS1p7mcaDthDh/MYUXnKTmJXzMQR5KnRJOxs7Zqru3UVUtd14O/4KyLe95DkHqg+annudHfsNgbc2XnOxScgjXc4FfFQ1RFVYFZSeXxQ1CoKvo6s0wHkO0P6BvlxuLA1OYn26ygc9EEXI6OJLsctHxKH2aDTZWdET8naF+iX5/CbA1vg6J6GPwxF65urebamehv3qgkoziCddNj4An+PM7KFYl0mg/k382tvhGa0IgPHL16HxRlne0Bo77sn9fQZDEOm6UJpqKSnSuaTncsLbx/Y1QjgdaoTrTB8XPc7qYI0LevEATObELw5ljiI3XWIwceEofm/BcieEYrkSYKR7NFlYjJNgZwQtY9om0m5ShwAAq8Uv2JImikv8xEjyv6Jo/wOcE0dkp7C8vwjN5lleenig+f2zwE5w+N42fY1ntqDVLfLTuPtlhtHBxu7usg1Uo9fRpdc6jQTgs3V9B0YqrLJOpmRFCXV/R5LVuGTvkXO78IfHf+YX0gbRESeNHoxsURmkoYFBM6nCsN00emfU5HieZRmnmsJ8cWzZjSdn2LXuY+Id9mJyYZTCcqmjb8mFcWtluqB7jHNbVtwtwPGnCM5YHLq5kHMa5xgVJ+RN88ij/tVdGWK54yOr9rbbXY689dedcnVIRszta1GbFUXN+kzlx9ZdHA3OGdzd+gFcGxhL6Jg4pcorJFBvheYuAeAqfh05YVDiZuWcwOT7A0X5PRjOFvLazFcH/HJCFP3ps8N5fiTvnVCetvjK6HUSyqwfxn5VyPlCxy7hCSPsj/6BW2PZKIg/F4WSHlPZEsTRMubHMHpddOILqjXIS4vw1SgTvZnLs6jHDH9tUXDko7K6/nYhO6V3BctUrXMl4MFZ8wD75H/+j+1khxN6hv6OSC9ZO3M2KGzTu7Zhe1F2cumAK6ZY401ZulbGulLzFdw3iORBFlwbe4b+AKxqIxF2G9wuduaJ9kOjYV64VHiQYPvi17GAm0VJeHHX7qpqtrL3CmYli68p3ECI1gBVnlhcqw20TcFJsUklQ9AnhJ8AYTkBiXwhMLi6RMzm2aWmxlyQFkSVYGsE162340PDNAw3NEx5uYJyEcb07mG9A1tBLTh9wXzDUlf/Lm4WLyI1j5odBnaKIjY/WTqw+aIB6XO0EI1W+3fO8Dj7nQ8loltw1unuK+1hb/+HiemvJxScsF8eyqYrrK4XvLFuhZxDwLNpT2k/JJe9drY1Y9OxT6Wauxb6XGyctSB66cLpE8gPdL+wUUfwTh4BO+mhqLrQq25O0b4mmrcdbzRZ67tylAZ+XVdk9+nYd7m3YED6BRulc5UPfrzbV+GgEDbX35nxPtfZ3z1cRHjcELBgvD5Kv6ZdTUVh1oA+ap5li+Wnk5s2z70m+FPzO8pd/YtwYcESZtSYRMG1WgErJ3+bevrLDVd1hSlU7gPlXjAyKFFYVRBp3ngCNtFUmcg/2pe9DZiZTfwTxOgyfK1qIeM+sKUSlOsdcAUDvs1Zk0sOWOGxlgtaCpafJUrEOYBFGY34wVEUCff3pKHumRlcdPA1Cxzx5TxiqKL6MHM3Dv+G29SHwKVH9OXfU37gDekVVVkU5dGfnz+M952hepZNhR0b3arLu7i0WFAvTxvrzNff/v29Hagxxcqt0oEhLMPiKe+k3H8DfwVxWurr8VzpjqEq1f0ttCMqr7UBsbDjbprzGzd/QpCLxHd6ccRKuIF0MFh58Sew775CY618nfNnxy7IsKKHIl94dcS65vPTMPkjrbFQyKdMrpBzPL4wn+foWKB1txCqqrseaZyvLPJkyZuZ731jVoup2dWWzwSnihwawv3YNaFv8Oa8TPLlIlVD1cJUlGXeJ8qy0VNQUPjcHzfGzlrwvUBBEdn9Z/pLAN7OroliZdDL+qa2/WjwuZE+fn7jRv7U+0FhasSr9JefDN7ADhR8DSS5CmCYNViq5q6daXrdKdVSvMtF6QI1THXzYvTXOfcDs+uQbyloqeeX9KZiuD0PZav3N6q7rfqz6zCSsL4vqe802JAc2jTjJA7HuGroKFmDFD5t9K4esRAGK+id4MmLFsorVlIHFziE+xPTvgutWbMTRTCmGh61TaeQd3Rrik9MIVFjA+FcrmgVSlXee3+jfF5YWeuXk0csX7ffJ+LkH4/MFaAC9g7+HfT+GvCgDvLA7JYazzwMbSiGKYx25tLlWq0qul1Pojju0b5qa5if895i2KEq8bJuMAeErZrzHzWiKKZFHPeBqqq1+C2XJxwRJMWChcOl7fNAGFmML72XawPhv/wEqdxTsYs6FmGssoTovSIniOY1IfQsGjlRFi3B6JqojpfkuWBnqiq7wrWFbOgrYBeD1BmTE3V+UdnVC7SN27l6MKjR1AxyyS2q8BaU/TKqNxRuiPtEx8vFUViayEuwAEwKhhvI1aVuTJ+AbopN0Z0jeIQvnIX3u4DoeJb2IS57L/xfqwSlDlzfzhB58Th0YidOOOUon4rcMpdcjvIfPGue6Cg/AX6Y/ab7L/Sh+7ViYu2ysm03vQP84oZPrBK7w+tE/PTrCu2c2zHZrdVLwg9Y+YMU7XjqhjCLeeU4ZKGVhe9/tDr/afCx7LQAC19FLdQZ8vOyY3ua9NUT6HBZ45CKlNlq1ft0Nfpj8qbkUn8uVKg/GVCqQk9AADmCUpXZQfD8vLfbt18lGrZHZ4rhy8/DwB8mfQclCNi/2NtfoCksxnvfhj8jqeyjJ47TXnKArdrsh2SAnndePYyGbjbOmDOg6BN7C8BmAmWTBjg5n2XJHXKbWYRw7iMmUcH3tQwrEaxHkitx1U4aLsLt5FD5BCxF+860YXm5RebTdoS8Elb0VVFzeBlejvFIWY9ED+JHhPDKd8icw73nPABCfexny10FGw4qSFT844fu9x/V2ZdTXU1ZF7Ps8HUnvkBOsM1JBdsH6QDBzvH99kx7/tmL7+two0rO9noCJ1G8sqjfapZaJFI9H/0fxPPHagAEv/e6gjxeZ14PxlGS5BQEZFQlF0W771G4bjWYNSmQece/usolC286UWzGyVix9uGu2hOJO+B3s2uh5QhiSb286XMl0qpqskqf61UEc+EJXzJLiit3G/d+Yn8HTXwI2DSz2gpoI0o5m2ceD8rYZlpBtnU5Ams0w7/TjhYaU8rCkdUjag9BhNtw5tMt0i5D3EWi0ynFCVUSN64x9cwrXsm5qnZ/xe6R3hX0573QmVQuIiVjlvTcLu4iFHZW1MrQTX9sIACgAbOjnRn5JSBLccA4YehnKOGr4L2jfG6yXs3OG6AT/PU0yhWzK0pK5fQRRKoODFuXiuyo9asp5U3AM6WBTXmO73LDNRnadQmqpVjtAdsO3aMyEMqP+Z8nzvOTd8hcAiZs4RzIROuRo4wIiq78NeOE7w2GbplYRQXKva5m0tPKAOnl1PoJsXeBKldWOb6fPGDBklwHL/omQyXUigzodcE68kJ/+aaM8L2mFULE3h/q2/+Fnfm4NSTGZlJ0KeKpPw5wHWiEkq/cyZ3S7aAP0mg/Dx7dX5GJn2kQ2PLxc7t+I10F5o+YZrM1aHwOvgK3YfyPivywPzuMVB+9aOrcI/QEx2TpyhKvjGefxyrEdnlFz4xPxgOPqeAw4KsJKS1BLV6pv3Fud1J77RIi3n95A2DD19XDcGXbU/z4BiBND7X+x+rEXblpIt1pzcjvLiiYscJToeqXzJmwQ5kguYUAHRhbmqoMOjWEx4Ul4S1E1tYYKBohvRUj5l2xuik6UKrbT9ecuA05ep81q5hmJsM+Ty5E6T8LqS3zjV+rCjojM+4QHZNEou4aiE7tigruGnJvVoiNS8GdIP/75p7fVQA/9r96iwKxSDfWdlRlFQhrJltzDrpDxp6AcLesIu7eH143jz2oeyznLe+oraM2l9TF2DzYiEgRxVaVoEZhallPle1k0DitlXgZwxfRf7gx7HHFP0N+6u4V3ShuTwx/qxJHFSTCqlitO4G8nODL1C4j2iYlGEZ61UWeUFx4TKISzD7rqd+LXwg2NMGsoCVXY0DGszkckoVAOVnHCoYeE2z+5b5lfiLdheY/aD5/dIXkT8MupMi+FE256zYWerjkGTQLD5Va6F8ogGtWefjDizGBvta2EvsXa3H/cDmCUMtn1MvD7HxQNpq1ZlVutwROpwiUgRUM7+LU3q82zHHhKFCccrKKDwxEupGlFv9qjb9POe3gETcPu/7NVh7m+UL2WfiN2Jkdjh3N0bekPzd1BfzuCRx1dkfdXw05210QIylU1u0CriK3/Ex0N1VuQG/JYRkyAc8+1IwInaW9kwIC7GvoLH2RA2QmrDHtJNbpu6wDsY4HaiHpR4wLwNC5C/lurbNlYtDbT66T/WZveJ2zdGL41wHY8/FroN9Y1v/1sWOQK8k6eUQuPnUiRM3T0d1ZZEWAbA44XU12AzXj8PxhL8QijYnlY14fKAzcpYKse24UbyPEXGP4iIAquW/1GxymLmaQzbWbozmQpf4Qs+jS64afdBPpN+gz02KI8zVPWroqaBefH87jEu+03x3e2302+y3Xq/HXpg/UTm2D1o8Hvdl+z+/cH9PhwNHId9OoQq6sQbaAFCS+DTLWi+p4EFN3a4qyCvYVmnC0rySeauWAwIxXwV/hUW+f3W0LDnMfbYFrR3WgOel4bpCdDEvVgduQHF3rf3BKZMPZzzo/ULJHSsJz1+EQHmdUiMeD2GTSdq4h3kBp89qXgdKE9VWcFbH+R8lTueNneS1XhAwbzBeqbPkfha78XNc4qA2O3BfSv3rJjjsdBi+04bziTjLRcTxNmlLvE8MFnf8kzWEapJ365ZuORlumFviWBUz4IFQWflBR8EYdu2U3Th4r4tT94DeoP1UcqvqH/L1rTg8Y0MHScP4RQLjzobx9fDmPBDUxxi2NjAw877IAXc24hPRhwwfaKfZUAP0TkYrR+E7GsKWdBA2qJ5n2R17PQCOJz+nXG5qjSo6q4yvyKZkkfg5Jsa5Y84Y/V8xL2Czf1DtfISUUlzxdiYEG1Kl2DUzB0/ymbOTYGn0ZiuCNXRC7h42IDhVtTu7PxPKhcz83Loi9BQmgIr0azgHZUPdrEk0r2y609c7cDBIKhvD5d85WZFEFxJkr5tMxKHtIBB1ZKntqNiC24HFHUbvpv0ab5okXeEghbuq5xdZbjR5MNPd4bkHHznFMlQdqzploBsX1DXr09De5DYxW1BvPpU8lHD857WhZ7NvVfE3MYA0LnZRUNMs5YE07fzr94Qc00B6sLeEFZTDnoNzdcegjxlaPmoQ+4x34W5ZkOjaUtMTVIyh6uB4VuHmh/bQAXpaDcgV2Wd/5BbxddMXHUskx8x+tnV2jZxS/YPKPct6m/U=
*/