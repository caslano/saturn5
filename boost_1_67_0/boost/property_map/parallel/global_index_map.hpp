// Copyright 2005 The Trustees of Indiana University.

// Use, modification and distribution is subject to the Boost Software
// License, Version 1.0. (See accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt)

//  Authors: Douglas Gregor
//           Andrew Lumsdaine
#ifndef BOOST_PARALLEL_GLOBAL_INDEX_MAP_HPP
#define BOOST_PARALLEL_GLOBAL_INDEX_MAP_HPP

#include <boost/property_map/property_map.hpp>
#include <vector>
#include <boost/shared_ptr.hpp>

namespace boost { namespace parallel {

template<typename IndexMap, typename GlobalMap>
class global_index_map
{
public:
  typedef typename property_traits<IndexMap>::key_type key_type;
  typedef typename property_traits<IndexMap>::value_type value_type;
  typedef value_type reference;
  typedef readable_property_map_tag category;

  template<typename ProcessGroup>
  global_index_map(ProcessGroup pg, value_type num_local_indices, 
                   IndexMap index_map, GlobalMap global)
    : index_map(index_map), global(global)
  {
    typedef typename ProcessGroup::process_id_type process_id_type;
    starting_index.reset(new std::vector<value_type>(num_processes(pg) + 1));
    send(pg, 0, 0, num_local_indices);
    synchronize(pg);
    
    // Populate starting_index in all processes
    if (process_id(pg) == 0) {
      (*starting_index)[0] = 0;
      for (process_id_type src = 0; src < num_processes(pg); ++src) {
        value_type n;
        receive(pg, src, 0, n);
        (*starting_index)[src + 1] = (*starting_index)[src] + n;
      }
      for (process_id_type dest = 1; dest < num_processes(pg); ++dest)
        send(pg, dest, 1, &starting_index->front(), num_processes(pg));
      synchronize(pg);
    } else {
      synchronize(pg);
      receive(pg, 0, 1, &starting_index->front(), num_processes(pg));
    }
  }

  friend inline value_type 
  get(const global_index_map& gim, const key_type& x)
  {
    using boost::get;
    return (*gim.starting_index)[get(gim.global, x).first]
           + get(gim.index_map, x);
  }

private:
  shared_ptr<std::vector<value_type> > starting_index;
  IndexMap index_map;
  GlobalMap global;
};

} } // end namespace boost::parallel

#endif // BOOST_PARALLEL_GLOBAL_INDEX_MAP_HPP

/* global_index_map.hpp
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
*/