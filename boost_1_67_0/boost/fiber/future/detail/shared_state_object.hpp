
//          Copyright Oliver Kowalke 2013.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_FIBERS_DETAIL_SHARED_STATE_OBJECT_H
#define BOOST_FIBERS_DETAIL_SHARED_STATE_OBJECT_H

#include <memory>

#include <boost/config.hpp>

#include <boost/fiber/detail/config.hpp>
#include <boost/fiber/future/detail/shared_state.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

namespace boost {
namespace fibers {
namespace detail {

template< typename R, typename Allocator >
class shared_state_object : public shared_state< R > {
public:
    typedef typename std::allocator_traits< Allocator >::template rebind_alloc< 
        shared_state_object
    >                                           allocator_type;

    shared_state_object( allocator_type const& alloc) :
        shared_state< R >{},
        alloc_{ alloc } {
    }

protected:
    void deallocate_future() noexcept override final {
        destroy_( alloc_, this);
    }

private:
    allocator_type             alloc_;

    static void destroy_( allocator_type const& alloc, shared_state_object * p) noexcept {
        allocator_type a{ alloc };
        typedef std::allocator_traits< allocator_type >    traity_type;
        traity_type::destroy( a, p);
        traity_type::deallocate( a, p, 1);
    }
};

}}}

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBERS_DETAIL_SHARED_STATE_OBJECT_H

/* shared_state_object.hpp
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
*/