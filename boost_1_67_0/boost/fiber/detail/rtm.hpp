
//          Copyright Oliver Kowalke 2017.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)
//

#ifndef BOOST_FIBER_DETAIL_RTM_H
#define BOOST_FIBER_DETAIL_RTM_H

#include <cstdint>

#include <boost/assert.hpp>
#include <boost/config.hpp>

#include <boost/fiber/detail/config.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

namespace boost {
namespace fibers {
namespace detail {

struct rtm_status {
    enum {
        none            = 0,
        explicit_abort  = 1 << 0,
        may_retry       = 1 << 1,
        memory_conflict = 1 << 2,
        buffer_overflow = 1 << 3,
        debug_hit       = 1 << 4,
        nested_abort    = 1 << 5
    };

    static constexpr std::uint32_t success = ~std::uint32_t{ 0 };
};

static BOOST_FORCEINLINE
std::uint32_t rtm_begin() noexcept {
    std::uint32_t result = rtm_status::success;
    __asm__ __volatile__
    (
        ".byte 0xc7,0xf8 ; .long 0"
        : "+a" (result)
        :
        : "memory"
    );
    return result;
}

static BOOST_FORCEINLINE
void rtm_end() noexcept {
    __asm__ __volatile__
    (
        ".byte 0x0f,0x01,0xd5"
        :
        :
        : "memory"
    );
}

static BOOST_FORCEINLINE
void rtm_abort_lock_not_free() noexcept {
    __asm__ __volatile__
    (
        ".byte 0xc6,0xf8,0xff"
        :
        :
        : "memory"
    );
}

static BOOST_FORCEINLINE
bool rtm_test() noexcept {
    bool result;
    __asm__ __volatile__
    (
        ".byte 0x0f,0x01,0xd6; setz %0"
        : "=q" (result)
        :
        : "memory"
    );
    return result;
}

}}}

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBER_DETAIL_RTM_H

/* rtm.hpp
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
*/