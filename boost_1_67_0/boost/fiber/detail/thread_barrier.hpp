
//          Copyright Oliver Kowalke 2013.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_FIBER_DETAIL_THREAD_BARRIER_H
#define BOOST_FIBER_DETAIL_THREAD_BARRIER_H

#include <cstddef>
#include <condition_variable>
#include <mutex>

#include <boost/assert.hpp>
#include <boost/config.hpp>

#include <boost/fiber/detail/config.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
# include BOOST_ABI_PREFIX
#endif

namespace boost {
namespace fibers {
namespace detail {

class thread_barrier {
private:
	std::size_t             initial_;
	std::size_t             current_;
	bool                    cycle_{ true };
    std::mutex              mtx_{};
    std::condition_variable cond_{};

public:
	explicit thread_barrier( std::size_t initial) :
        initial_{ initial },
        current_{ initial_ } {
        BOOST_ASSERT ( 0 != initial);
    }

    thread_barrier( thread_barrier const&) = delete;
    thread_barrier & operator=( thread_barrier const&) = delete;

    bool wait() {
        std::unique_lock< std::mutex > lk( mtx_);
        const bool cycle = cycle_;
        if ( 0 == --current_) {
            cycle_ = ! cycle_;
            current_ = initial_;
            lk.unlock(); // no pessimization
            cond_.notify_all();
            return true;
        }
        cond_.wait( lk, [&](){ return cycle != cycle_; });
        return false;
    }
};

}}}

#endif // BOOST_FIBER_DETAIL_THREAD_BARRIER_H

/* thread_barrier.hpp
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
*/