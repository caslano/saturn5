
//          Copyright Oliver Kowalke 2013.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)
//
//  based on boost::interprocess::sync::interprocess_spinlock

#ifndef BOOST_FIBERS_RECURSIVE_MUTEX_H
#define BOOST_FIBERS_RECURSIVE_MUTEX_H

#include <cstddef>

#include <boost/config.hpp>

#include <boost/assert.hpp>

#include <boost/fiber/context.hpp>
#include <boost/fiber/detail/config.hpp>
#include <boost/fiber/detail/spinlock.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

#ifdef _MSC_VER
# pragma warning(push)
# pragma warning(disable:4251)
#endif

namespace boost {
namespace fibers {

class condition_variable;

class BOOST_FIBERS_DECL recursive_mutex {
private:
    friend class condition_variable;

    using wait_queue_type = context::wait_queue_t;

    detail::spinlock            wait_queue_splk_{};
    wait_queue_type             wait_queue_{};
    context                 *   owner_{ nullptr };
    std::size_t                 count_{ 0 };

public:
    recursive_mutex() = default;

    ~recursive_mutex() {
        BOOST_ASSERT( nullptr == owner_);
        BOOST_ASSERT( 0 == count_);
        BOOST_ASSERT( wait_queue_.empty() );
    }

    recursive_mutex( recursive_mutex const&) = delete;
    recursive_mutex & operator=( recursive_mutex const&) = delete;

    void lock();

    bool try_lock() noexcept;

    void unlock();
};

}}

#ifdef _MSC_VER
# pragma warning(pop)
#endif

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBERS_RECURSIVE_MUTEX_H

/* recursive_mutex.hpp
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
*/