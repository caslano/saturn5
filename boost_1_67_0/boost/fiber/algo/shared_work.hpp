
//          Copyright Nat Goodspeed + Oliver Kowalke 2015.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_FIBERS_ALGO_SHARED_WORK_H
#define BOOST_FIBERS_ALGO_SHARED_WORK_H

#include <condition_variable>
#include <chrono>
#include <deque>
#include <mutex>

#include <boost/config.hpp>

#include <boost/fiber/algo/algorithm.hpp>
#include <boost/fiber/context.hpp>
#include <boost/fiber/detail/config.hpp>
#include <boost/fiber/scheduler.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

#ifdef _MSC_VER
# pragma warning(push)
# pragma warning(disable:4251)
#endif

namespace boost {
namespace fibers {
namespace algo {

class BOOST_FIBERS_DECL shared_work : public algorithm {
private:
    typedef std::deque< context * >  rqueue_type;
    typedef scheduler::ready_queue_type lqueue_type;

    static rqueue_type     	rqueue_;
    static std::mutex   	rqueue_mtx_;

    lqueue_type            	lqueue_{};
    std::mutex              mtx_{};
    std::condition_variable cnd_{};
    bool                    flag_{ false };
    bool                    suspend_{ false };

public:
    shared_work() = default;

    shared_work( bool suspend) :
        suspend_{ suspend } {
    }

	shared_work( shared_work const&) = delete;
	shared_work( shared_work &&) = delete;

	shared_work & operator=( shared_work const&) = delete;
	shared_work & operator=( shared_work &&) = delete;

    void awakened( context * ctx) noexcept override;

    context * pick_next() noexcept override;

    bool has_ready_fibers() const noexcept override {
        std::unique_lock< std::mutex > lock{ rqueue_mtx_ };
        return ! rqueue_.empty() || ! lqueue_.empty();
    }

	void suspend_until( std::chrono::steady_clock::time_point const& time_point) noexcept override;

	void notify() noexcept override;
};

}}}

#ifdef _MSC_VER
# pragma warning(pop)
#endif

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_FIBERS_ALGO_SHARED_WORK_H

/* shared_work.hpp
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
*/