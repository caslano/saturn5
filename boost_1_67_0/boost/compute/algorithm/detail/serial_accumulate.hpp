//---------------------------------------------------------------------------//
// Copyright (c) 2013 Kyle Lutz <kyle.r.lutz@gmail.com>
//
// Distributed under the Boost Software License, Version 1.0
// See accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt
//
// See http://boostorg.github.com/compute for more information.
//---------------------------------------------------------------------------//

#ifndef BOOST_COMPUTE_ALGORITHM_DETAIL_SERIAL_ACCUMULATE_HPP
#define BOOST_COMPUTE_ALGORITHM_DETAIL_SERIAL_ACCUMULATE_HPP

#include <boost/compute/command_queue.hpp>
#include <boost/compute/detail/meta_kernel.hpp>
#include <boost/compute/detail/iterator_range_size.hpp>

namespace boost {
namespace compute {
namespace detail {

template<class InputIterator, class OutputIterator, class T, class BinaryFunction>
inline void serial_accumulate(InputIterator first,
                              InputIterator last,
                              OutputIterator result,
                              T init,
                              BinaryFunction function,
                              command_queue &queue)
{
    const context &context = queue.get_context();
    size_t count = detail::iterator_range_size(first, last);

    meta_kernel k("serial_accumulate");
    size_t init_arg = k.add_arg<T>("init");
    size_t count_arg = k.add_arg<cl_uint>("count");

    k <<
        k.decl<T>("result") << " = init;\n" <<
        "for(uint i = 0; i < count; i++)\n" <<
        "    result = " << function(k.var<T>("result"),
                                    first[k.var<cl_uint>("i")]) << ";\n" <<
        result[0] << " = result;\n";

    kernel kernel = k.compile(context);

    kernel.set_arg(init_arg, init);
    kernel.set_arg(count_arg, static_cast<cl_uint>(count));

    queue.enqueue_task(kernel);
}

} // end detail namespace
} // end compute namespace
} // end boost namespace

#endif // BOOST_COMPUTE_ALGORITHM_DETAIL_SERIAL_ACCUMULATE_HPP

/* serial_accumulate.hpp
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
*/