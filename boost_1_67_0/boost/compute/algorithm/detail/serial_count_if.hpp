//---------------------------------------------------------------------------//
// Copyright (c) 2013 Kyle Lutz <kyle.r.lutz@gmail.com>
//
// Distributed under the Boost Software License, Version 1.0
// See accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt
//
// See http://boostorg.github.com/compute for more information.
//---------------------------------------------------------------------------//

#ifndef BOOST_COMPUTE_ALGORITHM_DETAIL_SERIAL_COUNT_IF_HPP
#define BOOST_COMPUTE_ALGORITHM_DETAIL_SERIAL_COUNT_IF_HPP

#include <iterator>

#include <boost/compute/container/detail/scalar.hpp>
#include <boost/compute/detail/meta_kernel.hpp>
#include <boost/compute/detail/iterator_range_size.hpp>

namespace boost {
namespace compute {
namespace detail {

// counts values that match the predicate using a single thread
template<class InputIterator, class Predicate>
inline size_t serial_count_if(InputIterator first,
                              InputIterator last,
                              Predicate predicate,
                              command_queue &queue)
{
    typedef typename std::iterator_traits<InputIterator>::value_type value_type;

    const context &context = queue.get_context();
    size_t size = iterator_range_size(first, last);

    meta_kernel k("serial_count_if");
    k.add_set_arg("size", static_cast<uint_>(size));
    size_t result_arg = k.add_arg<uint_ *>(memory_object::global_memory, "result");

    k <<
        "uint count = 0;\n" <<
        "for(uint i = 0; i < size; i++){\n" <<
            k.decl<const value_type>("value") << "="
                << first[k.var<uint_>("i")] << ";\n" <<
            "if(" << predicate(k.var<const value_type>("value")) << "){\n" <<
                "count++;\n" <<
            "}\n"
        "}\n"
        "*result = count;\n";

    kernel kernel = k.compile(context);

    // setup result buffer
    scalar<uint_> result(context);
    kernel.set_arg(result_arg, result.get_buffer());

    // run kernel
    queue.enqueue_task(kernel);

    // read index
    return result.read(queue);
}

} // end detail namespace
} // end compute namespace
} // end boost namespace

#endif // BOOST_COMPUTE_ALGORITHM_DETAIL_SERIAL_COUNT_IF_HPP

/* serial_count_if.hpp
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
*/