// Copyright 2005 The Trustees of Indiana University.

// Use, modification and distribution is subject to the Boost Software
// License, Version 1.0. (See accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt)

//  Authors: Douglas Gregor
//           Andrew Lumsdaine

#ifndef BOOST_GRAPH_PARALLEL_INPLACE_ALL_TO_ALL_HPP
#define BOOST_GRAPH_PARALLEL_INPLACE_ALL_TO_ALL_HPP

#ifndef BOOST_GRAPH_USE_MPI
#error "Parallel BGL files should not be included unless <boost/graph/use_mpi.hpp> has been included"
#endif

//
// Implements the inplace all-to-all communication algorithm.
//
#include <vector>
#include <iterator>

namespace boost { namespace parallel { 

template<typename ProcessGroup, typename T>
// where {LinearProcessGroup<ProcessGroup>, MessagingProcessGroup<ProcessGroup>}
void 
inplace_all_to_all(ProcessGroup pg, 
                   const std::vector<std::vector<T> >& outgoing,
                   std::vector<std::vector<T> >& incoming)
{
  typedef typename std::vector<T>::size_type size_type;

  typedef typename ProcessGroup::process_size_type process_size_type;
  typedef typename ProcessGroup::process_id_type process_id_type;

  process_size_type p = num_processes(pg);

  // Make sure there are no straggling messages
  synchronize(pg);

  // Send along the count (always) and the data (if count > 0)
  for (process_id_type dest = 0; dest < p; ++dest) {
    if (dest != process_id(pg)) {
      send(pg, dest, 0, outgoing[dest].size());
      if (!outgoing[dest].empty())
        send(pg, dest, 1, &outgoing[dest].front(), outgoing[dest].size());
    }
  }

  // Make sure all of the data gets transferred
  synchronize(pg);

  // Receive the sizes and data
  for (process_id_type source = 0; source < p; ++source) {
    if (source != process_id(pg)) {
      size_type size;
      receive(pg, source, 0, size);
      incoming[source].resize(size);
      if (size > 0)
        receive(pg, source, 1, &incoming[source].front(), size);
    } else if (&incoming != &outgoing) {
      incoming[source] = outgoing[source];
    }
  }
}

template<typename ProcessGroup, typename T>
// where {LinearProcessGroup<ProcessGroup>, MessagingProcessGroup<ProcessGroup>}
void 
inplace_all_to_all(ProcessGroup pg, std::vector<std::vector<T> >& data)
{
  inplace_all_to_all(pg, data, data);
}

} } // end namespace boost::parallel

#endif // BOOST_GRAPH_PARALLEL_INPLACE_ALL_TO_ALL_HPP

/* inplace_all_to_all.hpp
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
*/