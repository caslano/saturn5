
//          Copyright Oliver Kowalke 2014.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_CONTEXT_SEGMENTED_H
#define BOOST_CONTEXT_SEGMENTED_H

#include <cstddef>
#include <new>

#include <boost/config.hpp>

#include <boost/context/detail/config.hpp>
#include <boost/context/stack_context.hpp>
#include <boost/context/stack_traits.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

// forward declaration for splitstack-functions defined in libgcc
extern "C" {
void *__splitstack_makecontext( std::size_t,
                                void * [BOOST_CONTEXT_SEGMENTS],
                                std::size_t *);

void __splitstack_releasecontext( void * [BOOST_CONTEXT_SEGMENTS]);

void __splitstack_resetcontext( void * [BOOST_CONTEXT_SEGMENTS]);

void __splitstack_block_signals_context( void * [BOOST_CONTEXT_SEGMENTS],
                                         int * new_value, int * old_value);
}

namespace boost {
namespace context {

template< typename traitsT >
class basic_segmented_stack {
private:
    std::size_t     size_;

public:
    typedef traitsT traits_type;

    basic_segmented_stack( std::size_t size = traits_type::default_size() ) BOOST_NOEXCEPT_OR_NOTHROW :
        size_( size) {
    }

    stack_context allocate() {
        stack_context sctx;
        void * vp = __splitstack_makecontext( size_, sctx.segments_ctx, & sctx.size);
        if ( ! vp) throw std::bad_alloc();

        // sctx.size is already filled by __splitstack_makecontext
        sctx.sp = static_cast< char * >( vp) + sctx.size;

        int off = 0;
        __splitstack_block_signals_context( sctx.segments_ctx, & off, 0);

        return sctx;
    }

    void deallocate( stack_context & sctx) BOOST_NOEXCEPT_OR_NOTHROW {
        __splitstack_releasecontext( sctx.segments_ctx);
    }
};

typedef basic_segmented_stack< stack_traits > segmented_stack;
# if defined(BOOST_USE_SEGMENTED_STACKS)
typedef segmented_stack default_stack;
# endif

}}

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_CONTEXT_SEGMENTED_H

/* segmented_stack.hpp
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
*/