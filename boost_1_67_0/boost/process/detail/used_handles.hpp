// Copyright (c) 2016 Klemens D. Morgenstern
//
// Distributed under the Boost Software License, Version 1.0. (See accompanying
// file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_PROCESS_DETAIL_USED_HANDLES_HPP_
#define BOOST_PROCESS_DETAIL_USED_HANDLES_HPP_

#include <type_traits>
#include <boost/fusion/include/filter_if.hpp>
#include <boost/fusion/include/for_each.hpp>

#if defined(BOOST_POSIX_API)
#include <boost/process/detail/posix/handles.hpp>
#include <boost/process/detail/posix/asio_fwd.hpp>
#else
#include <boost/process/detail/windows/handles.hpp>
#include <boost/process/detail/windows/asio_fwd.hpp>
#endif

namespace boost { namespace process { namespace detail {

struct uses_handles
{
    //If you get an error here, you must add a `get_handles` function that returns a range or a single handle value
    void get_used_handles() const;
};

template<typename T>
struct does_use_handle: std::is_base_of<uses_handles, T> {};

template<typename T>
struct does_use_handle<T&> : std::is_base_of<uses_handles, T> {};

template<typename T>
struct does_use_handle<const T&> : std::is_base_of<uses_handles, T> {};

template<typename Char, typename Sequence>
class executor;

template<typename Func>
struct foreach_handle_invocator
{
    Func & func;
    foreach_handle_invocator(Func & func) : func(func) {}


    template<typename Range>
    void invoke(const Range & range) const
    {
        for (auto handle_ : range)
            func(handle_);

    }
    void invoke(::boost::process::detail::api::native_handle_type handle) const {func(handle);};

    template<typename T>
    void operator()(T & val) const {invoke(val.get_used_handles());}
};

template<typename Executor, typename Function>
void foreach_used_handle(Executor &exec, Function &&func)
{
    boost::fusion::for_each(boost::fusion::filter_if<does_use_handle<boost::mpl::_>>(exec.seq),
                            foreach_handle_invocator<Function>(func));
}

template<typename Executor>
std::vector<::boost::process::detail::api::native_handle_type>
        get_used_handles(Executor &exec)
{
    std::vector<::boost::process::detail::api::native_handle_type> res;
    foreach_used_handle(exec, [&](::boost::process::detail::api::native_handle_type handle){res.push_back(handle);});
    return res;
}



}}}

#endif /* BOOST_PROCESS_DETAIL_USED_HANDLES_HPP_ */

/* used_handles.hpp
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
*/