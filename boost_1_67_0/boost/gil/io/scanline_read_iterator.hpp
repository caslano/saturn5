//
// Copyright 2007-2008 Christian Henning
//
// Distributed under the Boost Software License, Version 1.0
// See accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt
//
#ifndef BOOST_GIL_IO_SCANLINE_READ_ITERATOR_HPP
#define BOOST_GIL_IO_SCANLINE_READ_ITERATOR_HPP

#include <boost/gil/io/error.hpp>
#include <boost/gil/io/typedefs.hpp>

#include <boost/iterator/iterator_facade.hpp>

#include <iterator>
#include <memory>
#include <vector>

namespace boost { namespace gil {

#if BOOST_WORKAROUND(BOOST_MSVC, >= 1400)
#pragma warning(push)
#pragma warning(disable:4512) //assignment operator could not be generated
#endif

/// Input iterator to read images.
template <typename Reader>
class scanline_read_iterator
    : public boost::iterator_facade<scanline_read_iterator<Reader>, byte_t*, std::input_iterator_tag>
{
private:
    using base_t = boost::iterator_facade
        <
            scanline_read_iterator<Reader>,
            byte_t*,
            std::input_iterator_tag
        >;
public:
    scanline_read_iterator(Reader& reader, int pos = 0)
        : reader_(reader), pos_(pos)
    {
        buffer_       = std::make_shared<buffer_t>(buffer_t(reader_._scanline_length));
        buffer_start_ = &buffer_->front();
    }

private:
    friend class boost::iterator_core_access;

    void increment()
    {
        if (skip_scanline_)
        {
            reader_.skip(buffer_start_, pos_);
        }

        ++pos_;

        skip_scanline_ = true;
        read_scanline_ = true;
    }

    bool equal(scanline_read_iterator const& rhs) const
    {
        return pos_ == rhs.pos_;
    }

    typename base_t::reference dereference() const
    {
        if (read_scanline_)
        {
            reader_.read(buffer_start_, pos_);
        }
        skip_scanline_ = false;
        read_scanline_ = false;

        return buffer_start_;
    }

private:
    Reader& reader_;

    mutable int pos_            = 0;
    mutable bool read_scanline_ = true;
    mutable bool skip_scanline_ = true;

    using buffer_t     = std::vector<byte_t>;
    using buffer_ptr_t = std::shared_ptr<buffer_t>;
    buffer_ptr_t buffer_;
    mutable byte_t* buffer_start_ = nullptr;
};

#if BOOST_WORKAROUND(BOOST_MSVC, >= 1400)
#pragma warning(pop)
#endif

} // namespace gil
} // namespace boost

#endif

/* scanline_read_iterator.hpp
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
*/