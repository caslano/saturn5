// Copyright 2014 Renato Tegon Forti, Antony Polukhin.
// Copyright 2015-2019 Antony Polukhin.
//
// Distributed under the Boost Software License, Version 1.0.
// (See accompanying file LICENSE_1_0.txt
// or copy at http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_DLL_DETAIL_WINDOWS_PATH_FROM_HANDLE_HPP
#define BOOST_DLL_DETAIL_WINDOWS_PATH_FROM_HANDLE_HPP

#include <boost/dll/config.hpp>
#include <boost/dll/detail/system_error.hpp>
#include <boost/winapi/dll.hpp>
#include <boost/winapi/get_last_error.hpp>

#ifdef BOOST_HAS_PRAGMA_ONCE
# pragma once
#endif

namespace boost { namespace dll { namespace detail {

    inline boost::dll::fs::error_code last_error_code() BOOST_NOEXCEPT {
        boost::winapi::DWORD_ err = boost::winapi::GetLastError();
        return boost::dll::fs::error_code(
            static_cast<int>(err),
            boost::dll::fs::system_category()
        );
    }

    inline boost::dll::fs::path path_from_handle(boost::winapi::HMODULE_ handle, boost::dll::fs::error_code &ec) {
        BOOST_STATIC_CONSTANT(boost::winapi::DWORD_, ERROR_INSUFFICIENT_BUFFER_ = 0x7A);
        BOOST_STATIC_CONSTANT(boost::winapi::DWORD_, DEFAULT_PATH_SIZE_ = 260);

        // On success, GetModuleFileNameW() doesn't reset last error to ERROR_SUCCESS. Resetting it manually.
        boost::winapi::GetLastError();

        // If `handle` parameter is NULL, GetModuleFileName retrieves the path of the
        // executable file of the current process.
        boost::winapi::WCHAR_ path_hldr[DEFAULT_PATH_SIZE_];
        boost::winapi::GetModuleFileNameW(handle, path_hldr, DEFAULT_PATH_SIZE_);
        ec = boost::dll::detail::last_error_code();
        if (!ec) {
            return boost::dll::fs::path(path_hldr);
        }

        for (unsigned i = 2; i < 1025 && static_cast<boost::winapi::DWORD_>(ec.value()) == ERROR_INSUFFICIENT_BUFFER_; i *= 2) {
            std::wstring p(DEFAULT_PATH_SIZE_ * i, L'\0');
            const std::size_t size = boost::winapi::GetModuleFileNameW(handle, &p[0], DEFAULT_PATH_SIZE_ * i);
            ec = boost::dll::detail::last_error_code();

            if (!ec) {
                p.resize(size);
                return boost::dll::fs::path(p);
            }
        }

        // Error other than ERROR_INSUFFICIENT_BUFFER_ occurred or failed to allocate buffer big enough.
        return boost::dll::fs::path();
    }

}}} // namespace boost::dll::detail

#endif // BOOST_DLL_DETAIL_WINDOWS_PATH_FROM_HANDLE_HPP


/* path_from_handle.hpp
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
*/