/*
 * Distributed under the Boost Software License, Version 1.0.
 * (See accompanying file LICENSE_1_0.txt or copy at
 * http://www.boost.org/LICENSE_1_0.txt)
 *
 * Copyright (c) 2014 Andrey Semashev
 */
/*!
 * \file   atomic/detail/ops_extending_cas_based.hpp
 *
 * This header contains a boilerplate of the \c operations template implementation that requires sign/zero extension in arithmetic operations.
 */

#ifndef BOOST_ATOMIC_DETAIL_OPS_EXTENDING_CAS_BASED_HPP_INCLUDED_
#define BOOST_ATOMIC_DETAIL_OPS_EXTENDING_CAS_BASED_HPP_INCLUDED_

#include <cstddef>
#include <boost/memory_order.hpp>
#include <boost/atomic/detail/config.hpp>
#include <boost/atomic/detail/storage_traits.hpp>
#include <boost/atomic/detail/integral_conversions.hpp>

#ifdef BOOST_HAS_PRAGMA_ONCE
#pragma once
#endif

namespace boost {
namespace atomics {
namespace detail {

template< typename Base, std::size_t Size, bool Signed >
struct extending_cas_based_operations :
    public Base
{
    typedef typename Base::storage_type storage_type;
    typedef typename storage_traits< Size >::type emulated_storage_type;

    static BOOST_FORCEINLINE storage_type fetch_add(storage_type volatile& storage, storage_type v, memory_order order) BOOST_NOEXCEPT
    {
        storage_type old_val;
        atomics::detail::non_atomic_load(storage, old_val);
        storage_type new_val;
        do
        {
            new_val = atomics::detail::integral_extend< Signed, storage_type >(static_cast< emulated_storage_type >(old_val + v));
        }
        while (!Base::compare_exchange_weak(storage, old_val, new_val, order, memory_order_relaxed));
        return old_val;
    }

    static BOOST_FORCEINLINE storage_type fetch_sub(storage_type volatile& storage, storage_type v, memory_order order) BOOST_NOEXCEPT
    {
        storage_type old_val;
        atomics::detail::non_atomic_load(storage, old_val);
        storage_type new_val;
        do
        {
            new_val = atomics::detail::integral_extend< Signed, storage_type >(static_cast< emulated_storage_type >(old_val - v));
        }
        while (!Base::compare_exchange_weak(storage, old_val, new_val, order, memory_order_relaxed));
        return old_val;
    }
};

} // namespace detail
} // namespace atomics
} // namespace boost

#endif // BOOST_ATOMIC_DETAIL_OPS_EXTENDING_CAS_BASED_HPP_INCLUDED_

/* ops_extending_cas_based.hpp
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
*/