// Copyright 2019 Hans Dembinski
//
// Distributed under the Boost Software License, Version 1.0.
// (See accompanying file LICENSE_1_0.txt
// or copy at http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_HISTOGRAM_DETAIL_ACCUMULATOR_TRAITS_HPP
#define BOOST_HISTOGRAM_DETAIL_ACCUMULATOR_TRAITS_HPP

#include <boost/histogram/detail/priority.hpp>
#include <boost/histogram/fwd.hpp>
#include <tuple>
#include <type_traits>

namespace boost {

// forward declare accumulator_set so that it can be matched below
namespace accumulators {
template <class, class, class>
struct accumulator_set;
}

namespace histogram {
namespace detail {

template <bool WeightSupport, class... Ts>
struct accumulator_traits_holder {
  static constexpr bool weight_support = WeightSupport;
  using args = std::tuple<Ts...>;
};

// member function pointer with weight_type as first argument is better match
template <class R, class T, class U, class... Ts>
accumulator_traits_holder<true, Ts...> accumulator_traits_impl_call_op(
    R (T::*)(boost::histogram::weight_type<U>, Ts...));

template <class R, class T, class U, class... Ts>
accumulator_traits_holder<true, Ts...> accumulator_traits_impl_call_op(
    R (T::*)(boost::histogram::weight_type<U>&, Ts...));

template <class R, class T, class U, class... Ts>
accumulator_traits_holder<true, Ts...> accumulator_traits_impl_call_op(
    R (T::*)(boost::histogram::weight_type<U>&&, Ts...));

template <class R, class T, class U, class... Ts>
accumulator_traits_holder<true, Ts...> accumulator_traits_impl_call_op(
    R (T::*)(const boost::histogram::weight_type<U>&, Ts...));

// member function pointer only considered if all specializations above fail
template <class R, class T, class... Ts>
accumulator_traits_holder<false, Ts...> accumulator_traits_impl_call_op(R (T::*)(Ts...));

template <class T>
auto accumulator_traits_impl(T&, priority<1>)
    -> decltype(accumulator_traits_impl_call_op(&T::operator()));

template <class T>
auto accumulator_traits_impl(T&, priority<1>)
    -> decltype(std::declval<T&>() += 0, accumulator_traits_holder<true>{});

template <class T>
auto accumulator_traits_impl(T&, priority<0>) -> accumulator_traits_holder<false>;

// for boost.accumulators compatibility
template <class S, class F, class W>
accumulator_traits_holder<false, S> accumulator_traits_impl(
    boost::accumulators::accumulator_set<S, F, W>&, priority<1>) {
  static_assert(std::is_same<W, void>::value,
                "accumulator_set with weights is not directly supported, please use "
                "a wrapper class that implements the Accumulator concept");
}

template <class T>
using accumulator_traits =
    decltype(accumulator_traits_impl(std::declval<T&>(), priority<1>{}));

} // namespace detail
} // namespace histogram
} // namespace boost

#endif

/* accumulator_traits.hpp
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
*/