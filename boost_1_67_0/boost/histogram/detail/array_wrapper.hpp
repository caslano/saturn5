// Copyright 2019 Hans Dembinski
//
// Distributed under the Boost Software License, Version 1.0.
// (See accompanying file LICENSE_1_0.txt
// or copy at http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_HISTOGRAM_DETAIL_ARRAY_WRAPPER_HPP
#define BOOST_HISTOGRAM_DETAIL_ARRAY_WRAPPER_HPP

#include <boost/core/nvp.hpp>
#include <boost/histogram/detail/span.hpp>
#include <boost/histogram/detail/static_if.hpp>
#include <boost/mp11/function.hpp>
#include <boost/mp11/utility.hpp>
#include <type_traits>

namespace boost {
namespace histogram {
namespace detail {

template <class T, class = decltype(&T::template save_array<int>)>
struct has_save_array_impl;

template <class T, class = decltype(&T::template load_array<int>)>
struct has_load_array_impl;

template <class T>
using has_array_optimization = mp11::mp_or<mp11::mp_valid<has_save_array_impl, T>,
                                           mp11::mp_valid<has_load_array_impl, T>>;

template <class T>
struct array_wrapper {
  using pointer = T*;

  pointer ptr;
  std::size_t size;

  template <class Archive>
  void serialize(Archive& ar, unsigned /* version */) {
    static_if_c<(has_array_optimization<Archive>::value &&
                 std::is_trivially_copyable<T>::value)>(
        [this](auto& ar) {
          // cannot use and therefore bypass save_array / load_array interface, because
          // it requires exact type boost::serialization::array_wrapper<T>
          static_if_c<Archive::is_loading::value>(
              [this](auto& ar) { ar.load_binary(this->ptr, sizeof(T) * this->size); },
              [this](auto& ar) { ar.save_binary(this->ptr, sizeof(T) * this->size); },
              ar);
        },
        [this](auto& ar) {
          for (auto&& x : boost::histogram::detail::make_span(this->ptr, this->size))
            ar& make_nvp("item", x);
        },
        ar);
  }
};

template <class T>
auto make_array_wrapper(T* t, std::size_t s) {
  return array_wrapper<T>{t, s};
}

} // namespace detail
} // namespace histogram
} // namespace boost

#endif

/* array_wrapper.hpp
+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
*/