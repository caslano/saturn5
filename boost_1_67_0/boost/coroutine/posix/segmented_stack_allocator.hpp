
//          Copyright Oliver Kowalke 2009.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)

#ifndef BOOST_COROUTINES_SEGMENTED_STACK_ALLOCATOR_H
#define BOOST_COROUTINES_SEGMENTED_STACK_ALLOCATOR_H

#include <cstddef>
#include <new>

#include <boost/config.hpp>

#include <boost/coroutine/detail/config.hpp>
#include <boost/coroutine/stack_context.hpp>
#include <boost/coroutine/stack_traits.hpp>

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_PREFIX
#endif

// forward declaration for splitstack-functions defined in libgcc
extern "C" {
void *__splitstack_makecontext( std::size_t,
                                void * [BOOST_CONTEXT_SEGMENTS],
                                std::size_t *);

void __splitstack_releasecontext( void * [BOOST_CONTEXT_SEGMENTS]);

void __splitstack_resetcontext( void * [BOOST_CONTEXT_SEGMENTS]);

void __splitstack_block_signals_context( void * [BOOST_CONTEXT_SEGMENTS],
                                         int * new_value, int * old_value);
}

namespace boost {
namespace coroutines {

template< typename traitsT >
struct basic_segmented_stack_allocator
{
    typedef traitsT traits_type;

    void allocate( stack_context & ctx, std::size_t size = traits_type::minimum_size() )
    {
        void * limit = __splitstack_makecontext( size, ctx.segments_ctx, & ctx.size);
        if ( ! limit) throw std::bad_alloc();

        // ctx.size is already filled by __splitstack_makecontext
        ctx.sp = static_cast< char * >( limit) + ctx.size;

        int off = 0;
        __splitstack_block_signals_context( ctx.segments_ctx, & off, 0);
    }

    void deallocate( stack_context & ctx)
    { __splitstack_releasecontext( ctx.segments_ctx); }
};

typedef basic_segmented_stack_allocator< stack_traits > segmented_stack_allocator;

}}

#ifdef BOOST_HAS_ABI_HEADERS
#  include BOOST_ABI_SUFFIX
#endif

#endif // BOOST_COROUTINES_SEGMENTED_STACK_ALLOCATOR_H

/* segmented_stack_allocator.hpp
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
*/